<!DOCTYPE html>



  


<html class="theme-next pisces use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="开发进阶知识," />










<meta name="description" content="行为模式负责对象间的高效沟通和职责委派">
<meta property="og:type" content="article">
<meta property="og:title" content="设计模式-行为模式">
<meta property="og:url" content="http://example.com/posts/23570.html">
<meta property="og:site_name" content="主页">
<meta property="og:description" content="行为模式负责对象间的高效沟通和职责委派">
<meta property="og:locale">
<meta property="og:image" content="http://example.com/posts/23570/image-20240410190903638.png">
<meta property="og:image" content="http://example.com/posts/23570/image-20240410191212009.png">
<meta property="og:image" content="http://example.com/posts/23570/image-20240410191935810.png">
<meta property="og:image" content="http://example.com/posts/23570/image-20240410192324723.png">
<meta property="og:image" content="http://example.com/posts/23570/image-20240410192410454.png">
<meta property="og:image" content="http://example.com/posts/23570/image-20240410192736440.png">
<meta property="og:image" content="http://example.com/posts/23570/image-20240410193119506.png">
<meta property="og:image" content="http://example.com/posts/23570/image-20240412184528332.png">
<meta property="og:image" content="http://example.com/posts/23570/image-20240412185130774.png">
<meta property="og:image" content="http://example.com/posts/23570/image-20240412185243002.png">
<meta property="og:image" content="http://example.com/posts/23570/image-20240412190345111.png">
<meta property="og:image" content="http://example.com/posts/23570/image-20240412190415337.png">
<meta property="og:image" content="http://example.com/posts/23570/image-20240412190602039.png">
<meta property="og:image" content="http://example.com/posts/23570/image-20240412191011676.png">
<meta property="og:image" content="http://example.com/posts/23570/image-20240412191420413.png">
<meta property="og:image" content="http://example.com/posts/23570/image-20240415181916755.png">
<meta property="og:image" content="http://example.com/posts/23570/image-20240415182302505.png">
<meta property="og:image" content="http://example.com/posts/23570/image-20240415182716568.png">
<meta property="og:image" content="http://example.com/posts/23570/image-20240422190409968.png">
<meta property="og:image" content="http://example.com/posts/23570/image-20240422191038669.png">
<meta property="og:image" content="http://example.com/posts/23570/image-20240422192149797.png">
<meta property="og:image" content="http://example.com/posts/23570/image-20240423100304200.png">
<meta property="og:image" content="http://example.com/posts/23570/image-20240423101135481.png">
<meta property="og:image" content="http://example.com/posts/23570/image-20240508182231899-1715163766878-1.png">
<meta property="og:image" content="http://example.com/posts/23570/image-20240508183247912.png">
<meta property="og:image" content="http://example.com/posts/23570/image-20240508184044562.png">
<meta property="og:image" content="http://example.com/posts/23570/image-20240508184338773.png">
<meta property="og:image" content="http://example.com/posts/23570/image-20240510183836914.png">
<meta property="og:image" content="http://example.com/posts/23570/image-20240510184407098.png">
<meta property="og:image" content="http://example.com/posts/23570/image-20240510184511992.png">
<meta property="og:image" content="http://example.com/posts/23570/image-20240510185054950.png">
<meta property="og:image" content="http://example.com/posts/23570/image-20240513101303209.png">
<meta property="og:image" content="http://example.com/posts/23570/image-20240513102217206.png">
<meta property="og:image" content="http://example.com/posts/23570/image-20240513103206910.png">
<meta property="og:image" content="http://example.com/posts/23570/image-20240513105611909.png">
<meta property="og:image" content="http://example.com/posts/23570/image-20240513121036352.png">
<meta property="og:image" content="http://example.com/posts/23570/image-20240513132839728.png">
<meta property="og:image" content="http://example.com/posts/23570/image-20240513133242266.png">
<meta property="og:image" content="http://example.com/posts/23570/image-20240513140306271.png">
<meta property="og:image" content="http://example.com/posts/23570/image-20240513140526165.png">
<meta property="og:image" content="http://example.com/posts/23570/image-20240513140821788.png">
<meta property="og:image" content="http://example.com/posts/23570/image-20240513140912818.png">
<meta property="og:image" content="http://example.com/posts/23570/image-20240513185628986.png">
<meta property="og:image" content="http://example.com/posts/23570/image-20240513190647685.png">
<meta property="og:image" content="http://example.com/posts/23570/image-20240513190955375.png">
<meta property="article:published_time" content="2024-04-10T10:51:54.000Z">
<meta property="article:modified_time" content="2024-05-13T11:25:15.000Z">
<meta property="article:author" content="Xu Zhipeng">
<meta property="article:tag" content="开发进阶知识">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://example.com/posts/23570/image-20240410190903638.png">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '',
    scheme: 'Pisces',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://example.com/posts/23570.html"/>





  <title>设计模式-行为模式 | 主页</title>
  








<meta name="generator" content="Hexo 6.3.0"><link rel="alternate" href="/atom.xml" title="主页" type="application/atom+xml">
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">主页</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">xzp个人小站</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            关于
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br />
            
            搜索
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off"
             placeholder="搜索..." spellcheck="false"
             type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://example.com/posts/23570.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="主页">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">设计模式-行为模式</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2024-04-10T18:51:54+08:00">
                2024-04-10
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/" itemprop="url" rel="index">
                    <span itemprop="name">编程语言</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  30.9k
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">
                  108
                </span>
              
            </div>
          

          
              <div class="post-description">
                  行为模式负责对象间的高效沟通和职责委派
              </div>
          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <h1 id="行为模式"><a href="#行为模式" class="headerlink" title="行为模式"></a>行为模式</h1><p>行为模式包括以下几种具体模式：</p>
<ul>
<li>责任链（Chain of Responsibility）：允许你将请求沿着处理者链进行发送。收到请求后，每个处理者均可对请求进行处理，或将其传递给链上的下个处理者。  </li>
<li>命令（Command）：它可将请求转换为一个包含与请求相关的所有信息的独立对象。该转换让你能根据不同的请求将方法参数化、延迟请求执行或将其放入队列中，且能实现可撤销操作。</li>
<li>迭代器（Iterator）：让你能在不暴露集合底层表现形式（列表、栈和树等）的情况下遍历集合中所有的元素</li>
<li>中介者（Mediator）：能让你减少对象之间混乱无序的依赖关系。该模式会限制对象之间的直接交互，迫使它们通过一个中介者对象进行合作。</li>
<li>备忘录（Memento）：允许在不暴露对象实现细节的情况下保存和恢复对象之前的状态。  </li>
<li>观察者（Observer）：允许你定义一种订阅机制，可在对象事件发生时通知多个“观察”该对象的其他对象</li>
<li>状态（State）：让你能在一个对象的内部状态变化时改变其行为，使其看上去就像改变了自身所属的类一样。  </li>
<li>策略（Strategy）：能让你定义一系列算法，并将每种算法分别放入独立的类中，以使算法的对象能够相互替换</li>
<li>模板方法（Template Method）：在超类中定义一个算法的框架，允许子类在不修改结构的情况下重写算法的特定步骤</li>
<li>访问者（Visitor）：将算法与其所作用的对象隔离开来</li>
</ul>
<h2 id="责任链"><a href="#责任链" class="headerlink" title="责任链"></a>责任链</h2><blockquote>
<p>职责链模式、命令链、CoR、Chain of Command、Chain of Responsibility</p>
</blockquote>
<p>责任链是一种行为设计模式，允许你将请求沿着处理者链进行发送。收到请求后，每个处理者均可对请求进行处理，或将其传递给链上的下个处理者。</p>
<h3 id="问题背景"><a href="#问题背景" class="headerlink" title="问题背景"></a>问题背景</h3><p>假设需要开发一个在线订购系统，希望对系统访问进行限制，只允许认证用户创建订单。此外，拥有管理权限的用户也拥有所有订单的完全访问权限。<br>简单规划后，你会意识到这些检查必须依次进行。只要接收到包含用户凭据的请求，应用程序就可尝试对进入系统的用户进行认证。 但如果由于用户凭据不正确而导致认证失败，那就没有必要进行后续检查了。</p>
<p><img src="/posts/23570/image-20240410190903638.png" alt="image-20240410190903638" style="zoom: 33%;"></p>
<p>后续有新增了如下功能：</p>
<ol>
<li>直接将原始数据传递给订购系统存在安全隐患。因此你新增了额外的验证步骤来清理请求中的数据。</li>
<li>系统无法抵御暴力密码破解方式的攻击。为了防范这种情况，你立刻添加了一个检查步骤来过滤来自同一 IP 地址的重复错误请求</li>
<li>对包含同样数据的重复请求返回缓存中的结果，从而提高系统响应速度。因此，你新增了一个检查步骤，确保只有没有满足条件的缓存结果时，请求才能通过并被发送给系统</li>
</ol>
<p><img src="/posts/23570/image-20240410191212009.png" alt="image-20240410191212009" style="zoom: 33%;"></p>
<p>检查代码本来就已经混乱不堪，而每次新增功能都会使其更加臃肿。修改某个检查步骤有时会影响其他的检查步骤。最糟糕的是，当你希望复用这些检查步骤来保护其他系统组件时，你只能复制部分代码，因为这些组件只需部分而非全部的检查步骤</p>
<p>系统会变得让人非常费解，而且其维护成本也会激增。你在艰难地和这些代码共处一段时间后，有一天终于决定对整个系统进行重构</p>
<h3 id="解决方案"><a href="#解决方案" class="headerlink" title="解决方案"></a>解决方案</h3><p>责任链会将特定行为转换为被称作处理者的独立对象。在上述示例中，每个检查步骤都可被抽取为仅有单个方法的类，并执行检查操作。请求及其数据则会被作为参数传递给该方法。</p>
<p>责任链模式建议将这些处理者连成一条链。链上的每个处理者都有一个成员变量来保存对于下一处理者的引用。除了处理请求外，处理者还负责沿着链传递请求。请求会在链上移动，直至所有处理者都有机会对其进行处理。</p>
<p>最重要的是：处理者可以决定不再沿着链传递请求，这可高效地取消所有后续处理步骤。</p>
<p>在订购系统示例中，处理者会在进行请求处理工作后决定是否继续沿着链传递请求。如果请求中包含正确的数据，所有处理者都将执行自己的主要行为，无论该行为是身份验证还是数据缓存。</p>
<p><img src="/posts/23570/image-20240410191935810.png" alt="image-20240410191935810" style="zoom: 33%;"></p>
<p>不过还有一种稍微不同的方式（也是更经典一种），那就是处理者接收到请求后自行决定是否能够对其进行处理。如果自己能够处理，处理者就不再继续传递请求。因此在这种情况下，每个请求要么最多有一个处理者对其进行处理，要么没有任何处理者对其进行处理。在处理图形用户界面元素栈中的事件时，这种方式非常常见。</p>
<p>例如，当用户点击按钮时，按钮产生的事件将沿着GUI元素链进行传递，最开始是按钮的容器（如窗体或面板），直至应用程序主窗口。链上第一个能处理该事件的元素会对其进行处理。此外，该例还有另一个值得我们关注的地方：它表明我们总能从对象树中抽取出链来。</p>
<p><img src="/posts/23570/image-20240410192324723.png" alt="image-20240410192324723" style="zoom:33%;"></p>
<p>所有处理者类均实现同一接口是关键所在。每个具体处理者仅关心下一个包含 execute 执行 方法的处理者。 这样一来，你就可以在运行时使用不同的处理者来创建链，而无需将相关代码与处理者的具体类进行耦合。  </p>
<h3 id="结构"><a href="#结构" class="headerlink" title="结构"></a>结构</h3><p><img src="/posts/23570/image-20240410192410454.png" alt="image-20240410192410454" style="zoom:33%;"></p>
<ol>
<li><p>处理者（<code>Handler</code>）声明了所有具体处理者的通用接口。该接口通常仅包含单个方法用于请求处理，但有时其还会包含一个设置链上下个处理者的方法。</p>
</li>
<li><p>基础处理者（<code>Base Handler</code>）是一个可选的类，你可以将所有处理者共用的样本代码放置在其中</p>
<p>通常情况下，该类中定义了一个保存下个处理者引用的成员变量。客户端可通过将处理者传递给上个处理者的构造函数或设定方法来创建链。该类还可以实现默认的处理行为：确定下个处理者存在后再将请求传递给它  </p>
</li>
<li><p>具体处理者（<code>Concrete Handlers</code>）包含处理请求的实际代码。每个处理者接收到请求后，都必须决定是否进行处理，以及<br>是否沿着链传递请求</p>
<p>处理者通常是独立且不可变的，需要通过构造函数一次性地获得所有必要的数据</p>
</li>
<li><p>客户端（<code>Client</code>）可根据程序逻辑一次性或者动态地生成链。值得注意的是，请求可发送给链上的任意一个处理者，而非<br>必须是第一个处理者</p>
</li>
</ol>
<h3 id="伪代码"><a href="#伪代码" class="headerlink" title="伪代码"></a>伪代码</h3><p>责任链模式负责为活动的GUI元素显示上下文帮助信息</p>
<p><img src="/posts/23570/image-20240410192736440.png" alt="image-20240410192736440" style="zoom:33%;"></p>
<p>应用程序的GUI通常为对象树结构。 例如， 负责渲染程序主窗口的 对话框 类就是对象树的根节点。 对话框包含面板 ，而面板可能包含其他面板，或是 按钮 和 文本框等下层元素  </p>
<p><img src="/posts/23570/image-20240410193119506.png" alt="image-20240410193119506" style="zoom:33%;"></p>
<p>只要给一个简单的组件指定帮助文本，它就可显示简短的上下文提示。但更复杂的组件可自定义上下文帮助文本的显示方式，例如显示手册摘录内容或在浏览器中打开一个网页</p>
<p>当用户将鼠标指针移动到某个元素并按下 F1 键时，程序检测到指针下的组件并对其发送帮助请求。该请求不断向上传递到该元素所有的容器，直至某个元素能够显示帮助信息</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title class_">Component</span> <span class="keyword">implements</span> <span class="title class_">ComponentWithContextualHelp</span> is</span><br><span class="line">	field tooltipText: string</span><br><span class="line">	</span><br><span class="line">	<span class="comment">// 组件容器在处理者链中作为“下一个”链接</span></span><br><span class="line">	<span class="keyword">protected</span> field container: Container</span><br><span class="line">	</span><br><span class="line">	<span class="comment">// 如果组件设定了帮助文字，那它将会显示提示信息。如果组件没有帮助文字且其容器存在，那它会将调用传递给容器。</span></span><br><span class="line">	method <span class="title function_">showHelp</span><span class="params">()</span> is</span><br><span class="line">	</span><br><span class="line">	<span class="title function_">if</span> <span class="params">(tooltipText != <span class="literal">null</span>)</span></span><br><span class="line">		<span class="comment">// 显示提示信息。</span></span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  	container.showHelp()</span><br><span class="line">  	</span><br><span class="line"><span class="comment">// 容器可以将简单组件和其他容器作为其子项目。链关系将在这里建立。该类将从其父类处继承showHelp（显示帮助）的行为。</span></span><br><span class="line"><span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title class_">Container</span> <span class="keyword">extends</span> <span class="title class_">Component</span> is</span><br><span class="line">	<span class="keyword">protected</span> field children: array of Component</span><br><span class="line">	method <span class="title function_">add</span><span class="params">(child)</span> is</span><br><span class="line">		children.add(child)</span><br><span class="line">		child.container = <span class="built_in">this</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 原始组件应该能够使用帮助操作的默认实现..</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Button</span> <span class="keyword">extends</span> <span class="title class_">Component</span> is</span><br><span class="line">	<span class="comment">// ...</span></span><br><span class="line">	</span><br><span class="line">但复杂组件可能会对默认实现进行重写。如果无法以新的方式来提供帮助文字，那组件总是还能调用基础实现的（参见Component类）。<span class="keyword">class</span> <span class="title class_">Panel</span> <span class="keyword">extends</span> <span class="title class_">Container</span> is</span><br><span class="line">	field modalHelpText: string</span><br><span class="line">	</span><br><span class="line">	method <span class="title function_">showHelp</span><span class="params">()</span> is</span><br><span class="line">		<span class="title function_">if</span> <span class="params">(modalHelpText != <span class="literal">null</span>)</span></span><br><span class="line">			<span class="comment">//显示包含帮助文字的模态窗口。</span></span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    	Super.showHelp()</span><br><span class="line">    	</span><br><span class="line">    	</span><br><span class="line"><span class="comment">//...同上...</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Dialog</span> <span class="keyword">extends</span> <span class="title class_">Container</span> is</span><br><span class="line">	field wikiPageURL: String</span><br><span class="line">	</span><br><span class="line">	method <span class="title function_">showHelp</span><span class="params">()</span> is</span><br><span class="line">		<span class="title function_">if</span> <span class="params">(wikiPageURL != <span class="literal">null</span>)</span></span><br><span class="line">			<span class="comment">//打开百科帮助页面。</span></span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    	Super.showHelp()</span><br><span class="line">    	</span><br><span class="line">    	</span><br><span class="line"><span class="comment">//客户端代码。</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Application</span> is</span><br><span class="line">	<span class="comment">//每个程序都能以不同方式对链进行配置。</span></span><br><span class="line">	method <span class="title function_">createUI</span><span class="params">()</span> <span class="type">is</span></span><br><span class="line">		<span class="variable">dialog</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Dialog</span>(<span class="string">&quot;预算报告&quot;</span>)</span><br><span class="line">		dialog.wikiPageURL = <span class="string">&quot;http://...&quot;</span></span><br><span class="line">		panel = <span class="keyword">new</span> <span class="title class_">Panel</span>(<span class="number">0</span>, <span class="number">0</span>, <span class="number">400</span>, <span class="number">800</span>)</span><br><span class="line">		panel.modalHelpText=<span class="string">&quot;本面板用于...&quot;</span></span><br><span class="line">		ok=<span class="keyword">new</span> <span class="title class_">Button</span>(<span class="number">250</span>，<span class="number">760</span>，<span class="number">50</span>，<span class="number">20</span>，“确认<span class="string">&quot;)</span></span><br><span class="line"><span class="string">		ok.tooltipText=&quot;</span>这是一个确认按钮...<span class="string">&quot;</span></span><br><span class="line"><span class="string">		cancel=newButton（320，760，50，20，&quot;</span>取消<span class="string">&quot;)</span></span><br><span class="line"><span class="string">		panel.add(ok)</span></span><br><span class="line"><span class="string">		panel.add(cancel)</span></span><br><span class="line"><span class="string">		dialog.add(panel)</span></span><br><span class="line"><span class="string">		</span></span><br><span class="line"><span class="string">  method onF1KeyPress()</span></span><br><span class="line"><span class="string">  	component = this.getComponentAtMouseCoords()</span></span><br><span class="line"><span class="string">  	component.showHelp()</span></span><br></pre></td></tr></table></figure>
<h3 id="应用场景"><a href="#应用场景" class="headerlink" title="应用场景"></a>应用场景</h3><ul>
<li><p>当程序需要使用不同方式处理不同种类请求，而且请求类型和顺序预先未知时，可以使用责任链模式</p>
<p>该模式能将多个处理者连接成一条链。接收到请求后，它会“询问”每个处理者是否能够对其进行处理。这样所有处理者都有机会来处理请求</p>
</li>
<li><p>当必须按顺序执行多个处理者时，可以使用该模式</p>
<p>无论你以何种顺序将处理者连接成一条链，所有请求都会严格按照顺序通过链上的处理者。</p>
</li>
<li><p>如果所需处理者及其顺序必须在运行时进行改变，可以使用责任链模式</p>
<p>如果在处理者类中有对引用成员变量的设定方法，你将能动态地插入和移除处理者，或者改变其顺序</p>
</li>
</ul>
<h3 id="实现方式"><a href="#实现方式" class="headerlink" title="实现方式"></a>实现方式</h3><ol>
<li><p>声明处理者接口并描述请求处理方法的签名</p>
<p>确定客户端如何将请求数据传递给方法。最灵活的方式是将请求转换为对象，然后将其以参数的形式传递给处理函数  </p>
</li>
<li><p>为了在具体处理者中消除重复的样本代码，你可以根据处理者接口创建抽象处理者基类</p>
<p>该类需要有一个成员变量来存储指向链上下个处理者的引用。你可以将其设置为不可变类。但如果你打算在运行时对链进行改变，则需要定义一个设定方法来修改引用成员变量的值</p>
<p>为了使用方便，你还可以实现处理方法的默认行为。如果还有剩余对象，该方法会将请求传递给下个对象。具体处理者还能够通过调用父对象的方法来使用这一行为  </p>
</li>
<li><p>依次创建具体处理者子类并实现其处理方法。每个处理者在接收到请求后都必须做出两个决定</p>
<ul>
<li>是否自行处理这个请求</li>
<li>是否将该请求沿着链进行传递</li>
</ul>
</li>
<li><p>客户端可以自行组装链，或者从其他对象处获得预先组装好的链。在后一种情况下，你必须实现工厂类以根据配置或环境设置来创建链</p>
</li>
<li><p>客户端可以触发链中的任意处理者，而不仅仅是第一个。请求将通过链进行传递，直至某个处理者拒绝继续传递，或者请求到达链尾</p>
</li>
<li><p>由于链的动态性，客户端需要准备好处理以下情况：</p>
<ul>
<li>链中可能只有单个链接</li>
<li>部分请求可能无法到达链尾</li>
<li>其他请求可能直到链尾都未被处理</li>
</ul>
</li>
</ol>
<h3 id="优缺点"><a href="#优缺点" class="headerlink" title="优缺点"></a>优缺点</h3><ul>
<li>你可以控制请求处理的顺序</li>
<li>单一职责原则。你可对发起操作和执行操作的类进行解耦</li>
<li>开闭原则。你可以在不更改现有代码的情况下在程序中新增处理者</li>
</ul>
<hr>
<ul>
<li>部分请求可能未被处理</li>
</ul>
<h3 id="与其他模式的关系"><a href="#与其他模式的关系" class="headerlink" title="与其他模式的关系"></a>与其他模式的关系</h3><ul>
<li><p>责任链、命令、中介者和观察者用于处理请求发送者和接收者之间的不同连接方式：</p>
<ul>
<li>责任链按照顺序将请求动态传递给一系列的潜在接收者，直至其中一名接收者对请求进行处理</li>
<li>命令在发送者和请求者之间建立单向连接</li>
<li>中介者清除了发送者和请求者之间的直接连接，强制它们通过一个中介对象进行间接沟通</li>
<li>观察者允许接收者动态地订阅或取消接收请求</li>
</ul>
</li>
<li><p>责任链通常和组合模式结合使用。在这种情况下，叶组件接收到请求后，可以将请求沿包含全体父组件的链一直传递至<br>对象树的底部</p>
</li>
<li><p>责任链的管理者可使用命令模式实现。在这种情况下，你可以对由请求代表的同一个上下文对象执行许多不同的操作</p>
<p>还有另外一种实现方式，那就是请求自身就是一个命令对象。在这种情况下，你可以对由一系列不同上下文连接而成的链执行相同的操作</p>
</li>
<li><p>责任链和装饰模式的类结构非常相似。两者都依赖递归组合将需要执行的操作传递给一系列对象。但是，两者有几点重要的不同之处</p>
<p>责任链的管理者可以相互独立地执行一切操作，还可以随时停止传递请求。另一方面，各种装饰可以在遵循基本接口的情况下扩展对象的行为。此外，装饰无法中断请求的传递。</p>
</li>
</ul>
<h2 id="命令"><a href="#命令" class="headerlink" title="命令"></a>命令</h2><blockquote>
<p>动作、事务、Action、Transaction、Command</p>
</blockquote>
<p>命令是一种行为设计模式，它可将请求转换为一个包含与请求相关的所有信息的独立对象。该转换让你能根据不同的请求将方法参数化、延迟请求执行或将其放入队列中，且能实现可撤销操作</p>
<h3 id="问题背景-1"><a href="#问题背景-1" class="headerlink" title="问题背景"></a>问题背景</h3><p>假如你正在开发一款新的文字编辑器，当前的任务是创建一个包含多个按钮的工具栏，并让每个按钮对应编辑器的不同操作。你创建了一个非常简洁的 按钮 类，它不仅可用于生成工具栏上的按钮，还可用于生成各种对话框的通用按钮。</p>
<p><img src="/posts/23570/image-20240412184528332.png" alt="image-20240412184528332" style="zoom:50%;"></p>
<p>尽管所有按钮看上去都很相似，但它们可以完成不同的操作（打开、保存、打印和应用等）。你会在哪里放置这些按钮的点击处理代码呢？最简单的解决方案是在使用按钮的每个地方都创建大量的子类。这些子类中包含按钮点击后必须执行的代码。</p>
<p><img src="/posts/23570/image-20240412185130774.png" alt="image-20240412185130774"></p>
<p>你很快就意识到这种方式有严重缺陷。首先，你创建了大量的子类，当每次修改基类 按钮 时，你都有可能需要修改所有子类的代码。简单来说，GUI代码以一种拙劣的方式依赖于业务逻辑中的不稳定代码。</p>
<p><img src="/posts/23570/image-20240412185243002.png" alt="image-20240412185243002"></p>
<p>还有一个部分最难办。复制/粘贴文字等操作可能会在多个地方被调用。例如用户可以点击工具栏上小小的“复制”按钮，或者通过上下文菜单复制一些内容，又或者直接使用键盘上的 Ctrl+C。</p>
<p>我们的程序最初只有工具栏，因此可以使用按钮子类来实现各种不同操作。换句话来说， 复制按钮 <code>CopyButton</code> 子类包含复制文字的代码是可行的。在实现了上下文菜单、快捷方式和其他功能后，你要么需要将操作代码复制进许多个类中，要么需要让菜单依赖于按钮，而后者是更糟糕的选择</p>
<h3 id="解决方案-1"><a href="#解决方案-1" class="headerlink" title="解决方案"></a>解决方案</h3><p>优秀的软件设计通常会将关注点进行分离，而这往往会导致软件的分层。最常见的例子：一层负责用户图像界面；另一层负责业务逻辑。GUI层负责在屏幕上渲染美观的图形，捕获所有输入并显示用户和程序工作的结果。当需要完成一些重要内容时（比如计算月球轨道或撰写年度报告），GUI层则会将工作委派给业务逻辑底层。</p>
<p>这在代码中看上去就像这样：一个 GUI 对象传递一些参数来调用一个业务逻辑对象。这个过程通常被描述为一个对象发送请求给另一个对象</p>
<p> <img src="/posts/23570/image-20240412190345111.png" alt="image-20240412190345111"></p>
<p>命令模式建议GUI对象不直接提交这些请求。<strong>你应该将请求的所有细节（例如调用的对象、方法名称和参数列表）抽取出来组成命令类，该类中仅包含一个用于触发请求的方法。</strong></p>
<p>命令对象负责连接不同的GUI和业务逻辑对象。此后，GUI对象无需了解业务逻辑对象是否获得了请求，也无需了解其对请求进行处理的方式。GUI对象触发命令即可，命令对象会自行处理所有细节工作。</p>
<p><img src="/posts/23570/image-20240412190415337.png" alt="image-20240412190415337"></p>
<p>下一步是让所有命令实现相同的接口。该接口通常只有一个没有任何参数的执行方法，让你能在不和具体命令类耦合的情况下使用同一请求发送者执行不同命令。此外还有额外的好处，现在你能在运行时切换连接至发送者的命令对象，以此改变发送者的行为。</p>
<p>你可能会注意到遗漏的一块拼图——请求的参数。GUI 对象可以给业务层对象提供一些参数。但执行命令方法没有任何参数，所以我们如何将请求的详情发送给接收者呢？答案是：使用数据对命令进行预先配置，或者让其能够自行获取数据</p>
<p><img src="/posts/23570/image-20240412190602039.png" alt="image-20240412190602039" style="zoom:50%;"></p>
<p>让我们回到文本编辑器。应用命令模式后，我们不再需要任何按钮子类来实现点击行为。我们只需在 按钮 Button 基类中添加一个成员变量来存储对于命令对象的引用，并在点击后执行该命令即可  </p>
<p>你需要为每个可能的操作实现一系列命令类，并且根据按钮所需行为将命令和按钮连接起来</p>
<p>其他菜单、快捷方式或整个对话框等 GUI 元素都可以通过相同方式来实现。当用户与 GUI 元素交互时，与其连接的命令将会被执行。现在你很可能已经猜到了，与相同操作相关的元素将会被连接到相同的命令，从而避免了重复代码</p>
<p>最后，命令成为了减少 GUI 和业务逻辑层之间耦合的中间层。而这仅仅是命令模式所提供的一小部分好处  </p>
<h3 id="结构-1"><a href="#结构-1" class="headerlink" title="结构"></a>结构</h3><p><img src="/posts/23570/image-20240412191011676.png" alt="image-20240412191011676" style="zoom:50%;"></p>
<ol>
<li><p>发送者（<code>Sender</code>）——亦称“触发者（<code>Invoker</code>）”类负责对请求进行初始化，其中必须包含一个成员变量来存储对于命令对象的引用。发送者触发命令，而不向接收者直接发送请求。注意，发送者并不负责创建命令对象：它通常会通过构造函数从客户端处获得预先生成的命令</p>
</li>
<li><p>命令（<code>Command</code>）接口通常仅声明一个执行命令的方法</p>
</li>
<li><p>具体命令（<code>Concrete Commands</code>） 会实现各种类型的请求。具体命令自身并不完成工作，而是会将调用委派给一个业务逻辑对象。但为了简化代码，这些类可以进行合并</p>
<p>接收对象执行方法所需的参数可以声明为具体命令的成员变量。你可以将命令对象设为不可变，仅允许通过构造函数对这些成员变量进行初始化。  </p>
</li>
<li><p>接收者（<code>Receiver</code>）类包含部分业务逻辑。几乎任何对象都可以作为接收者。绝大部分命令只处理如何将请求传递到接收者的细节，接收者自己会完成实际的工作</p>
</li>
<li><p>客户端（<code>Client</code>）会创建并配置具体命令对象。客户端必须将包括接收者实体在内的所有请求参数传递给命令的构造函数。此后，生成的命令就可以与一个或多个发送者相关联了</p>
</li>
</ol>
<h3 id="伪代码-1"><a href="#伪代码-1" class="headerlink" title="伪代码"></a>伪代码</h3><p>命令模式会记录已执行操作的历史记录，以在需要时撤销操作</p>
<p><img src="/posts/23570/image-20240412191420413.png" alt="image-20240412191420413" style="zoom: 25%;"></p>
<p>有些命令会改变编辑器的状态（例如剪切和粘贴），它们可在执行相关操作前对编辑器的状态进行备份。命令执行后会和当前点备份的编辑器状态一起被放入命令历史（命令对象栈）。此后，如果用户需要进行回滚操作，程序可从历史记录中取出最近的命令，读取相应的编辑器状态备份，然后进行恢复。  </p>
<p>客户端代码（GUI 元素和命令历史等）没有和具体命令类相耦合，因为它通过命令接口来使用命令。这使得你能在无需修改已有代码的情况下在程序中增加新的命令  </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br></pre></td><td class="code"><pre><span class="line">/／命令基类会为所有具体命令定义通用接口。</span><br><span class="line"><span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title class_">Command</span> is</span><br><span class="line">	<span class="keyword">protected</span> field app:Application</span><br><span class="line">	<span class="keyword">protected</span> field editor:Editor</span><br><span class="line">	<span class="keyword">protected</span> field backup:text</span><br><span class="line">	</span><br><span class="line">	constructor <span class="title function_">Command</span><span class="params">(app: Application, editor: Editor)</span> is</span><br><span class="line">		<span class="built_in">this</span>.app = app</span><br><span class="line">		<span class="built_in">this</span>.editor = editor</span><br><span class="line">		</span><br><span class="line">  <span class="comment">//备份编辑器状态。	</span></span><br><span class="line">  method <span class="title function_">saveBackup</span><span class="params">()</span> <span class="type">is</span></span><br><span class="line">  	<span class="variable">backup</span> <span class="operator">=</span> editor.text</span><br><span class="line">  	</span><br><span class="line">  <span class="comment">//恢复编辑器状态。</span></span><br><span class="line">  method <span class="title function_">undo</span><span class="params">()</span> is</span><br><span class="line">  	editor.text = backup</span><br><span class="line">  	</span><br><span class="line">  <span class="comment">//执行方法被声明为抽象以强制所有具体命令提供自己的实现。该方法必须根据命令是否更改编辑器的状态返回true 或false。</span></span><br><span class="line">  <span class="keyword">abstract</span> method <span class="title function_">execute</span><span class="params">()</span></span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line"><span class="comment">//这里是具体命令。</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">CopyCommand</span> <span class="keyword">extends</span> <span class="title class_">Command</span> is</span><br><span class="line"><span class="comment">//复制命令不会被保存到历史记录中，因为它没有改变编辑器的状态。</span></span><br><span class="line">  method <span class="title function_">execute</span><span class="params">()</span> is</span><br><span class="line">    app.clipboard = editor.getSelection()</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">	</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">CutCommand</span> <span class="keyword">extends</span> <span class="title class_">Command</span> is</span><br><span class="line"><span class="comment">//剪切命令改变了编辑器的状态，因此它必须被保存到历史记录中。只要方法返回true，它就会被保存。</span></span><br><span class="line">	method <span class="title function_">execute</span><span class="params">()</span> is</span><br><span class="line">		<span class="title function_">saveBackup</span><span class="params">()</span></span><br><span class="line">		app.clipboard = editor.getSelection()</span><br><span class="line">		editor.deleteSelection()</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">PasteCommand</span> <span class="keyword">extends</span> <span class="title class_">Command</span> is</span><br><span class="line">	method <span class="title function_">execute</span><span class="params">()</span> is</span><br><span class="line">		<span class="title function_">saveBackup</span><span class="params">()</span></span><br><span class="line">		editor.replaceSelection(app.clipboard)</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">		</span><br><span class="line"><span class="comment">//撤销操作也是一个命令。</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">UndoCommand</span> <span class="keyword">extends</span> <span class="title class_">Command</span> is</span><br><span class="line">	method <span class="title function_">execute</span><span class="params">()</span> is</span><br><span class="line">		app.undo()</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">		</span><br><span class="line"><span class="comment">//全局命令历史记录就是一个堆栈。</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">CommandHistory</span> is</span><br><span class="line">	<span class="keyword">private</span> field history: array of Command</span><br><span class="line">	<span class="comment">//后进...</span></span><br><span class="line">	method <span class="title function_">push</span><span class="params">(c: Command)</span> is</span><br><span class="line">		<span class="comment">//将命令压入历史记录数组的末尾。</span></span><br><span class="line">		</span><br><span class="line">	<span class="comment">//...先出</span></span><br><span class="line">	method <span class="title function_">pop</span><span class="params">()</span>:Command is</span><br><span class="line">		<span class="comment">//从历史记录中取出最近的命令。</span></span><br><span class="line">		</span><br><span class="line"><span class="comment">// 编辑器类包含实际的文本编辑操作。它会担任接收者的角色：最后所有命令都会将执行工作委派给编辑器的方法。</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Editor</span> is</span><br><span class="line">	field text: string</span><br><span class="line">	method <span class="title function_">getSelection</span><span class="params">()</span> is</span><br><span class="line">		<span class="comment">//返回选中的文字。</span></span><br><span class="line">  method <span class="title function_">deleteSelection</span><span class="params">()</span> is</span><br><span class="line">  	<span class="comment">//删除选中的文字。</span></span><br><span class="line">  method <span class="title function_">replaceSelection</span><span class="params">(text)</span> is</span><br><span class="line">  	<span class="comment">//在当前位置插入剪贴板中的内容。</span></span><br><span class="line">  	</span><br><span class="line"><span class="comment">//应用程序类会设置对象之间的关系。它会担任发送者的角色：当需要完成某些工作时，它会创建并执行一个命令对象。</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Application</span> is</span><br><span class="line">	field clipboard: string</span><br><span class="line">	field editors: array of Editors</span><br><span class="line">	field activeEditor: Editor</span><br><span class="line">	field history: CommandHistory</span><br><span class="line">	</span><br><span class="line">	<span class="comment">//将命令分派给UI对象的代码可能会是这样的。</span></span><br><span class="line">	method <span class="title function_">createUI</span><span class="params">()</span> <span class="type">is</span></span><br><span class="line">		<span class="variable">copy</span> <span class="operator">=</span> function() &#123; executeCommand(</span><br><span class="line">			<span class="keyword">new</span> <span class="title class_">CopyCommand</span>(<span class="built_in">this</span>, activeEditor))&#125;</span><br><span class="line">    copyButton.setCommand(copy)</span><br><span class="line">    shortcuts.onKeyPress(<span class="string">&quot;Ctrl+C&quot;</span>, copy)</span><br><span class="line">    </span><br><span class="line">    cut = function() &#123;executeCommand(</span><br><span class="line">      	<span class="keyword">new</span> <span class="title class_">CutCommand</span>(<span class="built_in">this</span>, activeEditor))&#125;</span><br><span class="line">		cutButton.setCommand(cut)</span><br><span class="line">    shortcuts.onKeyPress(<span class="string">&quot;Ctrl+x&quot;</span>, cut)</span><br><span class="line">      </span><br><span class="line">    paste = function() &#123;executeCommand(<span class="keyword">new</span> <span class="title class_">PasteCommand</span>(<span class="built_in">this</span>, activeEditor))&#125;</span><br><span class="line">		pasteButton.setCommand(paste)</span><br><span class="line">    shortcuts.onKeyPress(<span class="string">&quot;Ctrl+V&quot;</span>, paste)</span><br><span class="line">      </span><br><span class="line">    undo = function() &#123; executeCommand(<span class="keyword">new</span> <span class="title class_">UndoCommand</span>(<span class="built_in">this</span>, activeEditor))&#125;</span><br><span class="line">		undoButton. setCommand(undo)</span><br><span class="line">    shortcuts.onKeyPress(<span class="string">&quot;Ctrl+Z&quot;</span>, undo)</span><br><span class="line">      </span><br><span class="line">      </span><br><span class="line">  <span class="comment">//执行一个命令并检查它是否需要被添加到历史记录中。</span></span><br><span class="line">  method <span class="title function_">executeCommand</span><span class="params">(command)</span> is</span><br><span class="line">        <span class="title function_">if</span> <span class="params">(command.execute)</span></span><br><span class="line">          history.push(command)</span><br><span class="line"></span><br><span class="line">  <span class="comment">//从历史记录中取出最近的命令并运行其undo（撤销）方法。请注意，你并不知晓该命令所属的类。但是我们不需要知晓，因为命令自己知道如何撤销其动作。</span></span><br><span class="line">  method <span class="title function_">undo</span><span class="params">(） is</span></span><br><span class="line"><span class="params">    command = history.pop()</span></span><br><span class="line">      <span class="keyword">if</span> (command != <span class="literal">null</span>)</span><br><span class="line">        command.undo( )</span><br></pre></td></tr></table></figure>
<h3 id="应用场景-1"><a href="#应用场景-1" class="headerlink" title="应用场景"></a>应用场景</h3><ul>
<li><p>如果你需要通过操作来参数化对象，可使用命令模式</p>
<p>命令模式可将特定的方法调用转化为独立对象。这一改变也带来了许多有趣的应用：你可以将命令作为方法的参数进行传递、将命令保存在其他对象中，或者在运行时切换已连接的命令等</p>
<p>举个例子： 你正在开发一个 GUI 组件（例如上下文菜单），<br>你希望用户能够配置菜单项，并在点击菜单项时触发操作</p>
</li>
<li><p>如果你想要将操作放入队列中、操作的执行或者远程执行操作，可使用命令模式</p>
<p>同其他对象一样，命令也可以实现序列化（序列化的意思是转化为字符串），从而能方便地写入文件或数据库中。一段时间后，该字符串可被恢复成为最初的命令对象。因此，你可以延迟或计划命令的执行。但其功能远不止如此！使用同样的方式，你还可以将命令放入队列、记录命令或者通过网络发送命令</p>
</li>
<li><p>如果你想要实现操作回滚功能，可使用命令模式</p>
<p>尽管有很多方法可以实现撤销和恢复功能，但命令模式可能是其中最常用的一种。</p>
<p>为了能够回滚操作，你需要实现已执行操作的历史记录功能。命令历史记录是一种包含所有已执行命令对象及其相关程序状态备份的栈结构</p>
<p>这种方法有两个缺点。首先，程序状态的保存功能并不容易实现，因为部分状态可能是私有的。你可以使用备忘录模式来在一定程度上解决这个问题。</p>
<p>其次，备份状态可能会占用大量内存。因此，有时你需要借助另一种实现方式：命令无需恢复原始状态，而是执行反向操作。反向操作也有代价：它可能会很难甚至是无法实现  </p>
</li>
</ul>
<h3 id="实现方式-1"><a href="#实现方式-1" class="headerlink" title="实现方式"></a>实现方式</h3><ol>
<li>声明仅有一个执行方法的命令接口</li>
<li>抽取请求并使之成为实现命令接口的具体命令类。每个类都必须有一组成员变量来保存请求参数和对于实际接收者对象的引用。所有这些变量的数值都必须通过命令构造函数进行初始化</li>
<li>找到担任发送者职责的类。在这些类中添加保存命令的成员变量。发送者只能通过命令接口与其命令进行交互。发送者自身通常并不创建命令对象，而是通过客户端代码获取</li>
<li>修改发送者使其执行命令，而非直接将请求发送给接收者</li>
<li>客户端必须按照以下顺序来初始化对象：<ol>
<li>创建接收者</li>
<li>创建命令，如有需要可将其关联至接收者</li>
<li>创建发送者并将其与特定命令关联</li>
</ol>
</li>
</ol>
<h3 id="优缺点-1"><a href="#优缺点-1" class="headerlink" title="优缺点"></a>优缺点</h3><ul>
<li>单一职责原则。你可以解耦触发和执行操作的类</li>
<li>开闭原则。你可以在不修改已有客户端代码的情况下在程序中创建新的命令</li>
<li>你可以实现撤销和恢复功能</li>
<li>你可以实现操作的延迟执行</li>
<li>你可以将一组简单命令组合成一个复杂命令</li>
</ul>
<hr>
<ul>
<li>代码可能会变得更加复杂，因为你在发送者和接收者之间增加了一个全新的层次</li>
</ul>
<h3 id="与其他模式的关系-1"><a href="#与其他模式的关系-1" class="headerlink" title="与其他模式的关系"></a>与其他模式的关系</h3><ul>
<li>责任链、命令、中介者和观察者用于处理请求发送者和接收者之间的不同连接方式：<ul>
<li>责任链按照顺序将请求动态传递给一系列的潜在接收者，直至其中一名接收者对请求进行处理</li>
<li>命令在发送者和请求者之间建立单向连接</li>
<li>中介者清除了发送者和请求者之间的直接连接，强制它们通过一个中介对象进行间接沟通</li>
<li>观察者允许接收者动态地订阅或取消接收请求</li>
</ul>
</li>
<li>责任链的管理者可使用命令模式实现。在这种情况下，你可以对由请求代表的同一个上下文对象执行许多不同的操作。<br>还有另外一种实现方式，那就是请求自身就是一个命令对象。在这种情况下，你可以对由一系列不同上下文连接而成的链执行相同的操作</li>
<li>你可以同时使用命令和备忘录来实现“撤销”。在这种情况下，命令用于对目标对象执行各种不同的操作，备忘录用来保存一条命令执行前该对象的状态</li>
<li>命令和策略看上去很像，因为两者都能通过某些行为来参数化对象。但是，它们的意图有非常大的不同<ul>
<li>你可以使用命令来将任何操作转换为对象。操作的参数将成为对象的成员变量。 你可以通过转换来延迟操作的执行、将操作放入队列、保存历史命令或者向远程服务发送命令等</li>
<li>另一方面，策略通常可用于描述完成某件事的不同方式，让你能够在同一个上下文类中切换算法</li>
</ul>
</li>
<li>原型可用于保存命令的历史记录</li>
<li>你可以将访问者视为命令模式的加强版本，其对象可对不同类的多种对象执行操作</li>
</ul>
<h2 id="迭代器"><a href="#迭代器" class="headerlink" title="迭代器"></a>迭代器</h2><blockquote>
<p>Iterator</p>
</blockquote>
<p>迭代器是一种行为设计模式，让你能在不暴露集合底层表现形式（列表、栈和树等）的情况下遍历集合中所有的元素。</p>
<h3 id="问题背景-2"><a href="#问题背景-2" class="headerlink" title="问题背景"></a>问题背景</h3><p>集合是编程中最常使用的数据类型之一。尽管如此，集合只是一组对象的容器而已。</p>
<p>大部分集合使用简单列表存储元素。但有些集合还会使用栈、树、图和其他复杂的数据结构。</p>
<p>无论集合的构成方式如何，它都必须提供某种访问元素的方式，便于其他代码使用其中的元素。集合应提供一种能够遍历元素的方式，且保证它不会周而复始地访问同一个元素。 </p>
<p>如果你的集合基于列表， 那么这项工作听上去仿佛很简单。但如何遍历复杂数据结构（例如树）中的元素呢？例如，今天你需要使用深度优先算法来遍历树结构，明天可能会需要广度优先算法；下周则可能会需要其他方式（比如随机存取树中的元素）。</p>
<p>不断向集合中添加遍历算法会模糊其“高效存储数据”的主要职责。此外，有些算法可能是根据特定应用订制的，将其加入泛型集合类中会显得非常奇怪。</p>
<p>另一方面，使用多种集合的客户端代码可能并不关心存储数据的方式。不过由于集合提供不同的元素访问方式，你的代码将不得不与特定集合类进行耦合。</p>
<h3 id="解决方案-2"><a href="#解决方案-2" class="headerlink" title="解决方案"></a>解决方案</h3><p>迭代器模式的主要思想是将集合的遍历行为抽取为单独的迭代器对象。</p>
<p><img src="/posts/23570/image-20240415181916755.png" alt="image-20240415181916755" style="zoom:33%;"></p>
<p>除实现自身算法外， 迭代器还封装了遍历操作的所有细节，例如当前位置和末尾剩余元素的数量。因此，多个迭代器可以在相互独立的情况下同时访问集合。</p>
<p>迭代器通常会提供一个获取集合元素的基本方法。客户端可不断调用该方法直至它不返回任何内容，这意味着迭代器已经遍历了所有元素。</p>
<p>所有迭代器必须实现相同的接口。这样一来，只要有合适的迭代器， 客户端代码就能兼容任何类型的集合或遍历算法。如果你需要采用特殊方式来遍历集合，只需创建一个新的迭代器类即可，无需对集合或客户端进行修改。</p>
<h3 id="结构-2"><a href="#结构-2" class="headerlink" title="结构"></a>结构</h3><p><img src="/posts/23570/image-20240415182302505.png" alt="image-20240415182302505" style="zoom:33%;"></p>
<ol>
<li><p>迭代器（<code>Iterator</code>）接口声明了遍历集合所需的操作：获取下<br>一个元素、获取当前位置和重新开始迭代等。</p>
</li>
<li><p>具体迭代器（<code>Concrete Iterators</code>）实现遍历集合的一种特定算法。迭代器对象必须跟踪自身遍历的进度。这使得多个迭代器可以相互独立地遍历同一集合。</p>
</li>
<li><p>集合（<code>Collection</code>）接口声明一个或多个方法来获取与集合兼容的迭代器。请注意，返回方法的类型必须被声明为迭代器接口，因此具体集合可以返回各种不同种类的迭代器</p>
</li>
<li><p>具体集合（<code>Concrete Collections</code>）会在客户端请求迭代器时返回一个特定的具体迭代器类实体。你可能会琢磨，剩下的集合代码在什么地方呢？不用担心，它也会在同一个类中。只是这些细节对于实际模式来说并不重要，所以我们将其省略了而已。 </p>
</li>
<li><p>客户端（<code>Client</code>）通过集合和迭代器的接口与两者进行交互。这样一来客户端无需与具体类进行耦合，允许同一客户端代码使用各种不同的集合和迭代器。</p>
<p>客户端通常不会自行创建迭代器，而是会从集合中获取。但在特定情况下，客户端可以直接创建一个迭代器（例如当客户端需要自定义特殊迭代器时）。    </p>
</li>
</ol>
<h3 id="伪代码-2"><a href="#伪代码-2" class="headerlink" title="伪代码"></a>伪代码</h3><p>迭代器模式用于遍历一个封装了访问微信好友关系功能的特殊集合。该集合提供使用不同方式遍历档案资料的多个迭代器</p>
<p><img src="/posts/23570/image-20240415182716568.png" alt="image-20240415182716568" style="zoom:33%;"></p>
<p>“好友（<code>friends</code>）”迭代器可用于遍历指定档案的好友。“同事（<code>colleagues</code>）”迭代器也提供同样的功能，但仅包括与目标用户在同一家公司工作的好友。这两个迭代器都实现了同一个通用接口，客户端能在不了解认证和发送 REST 请求等实现细节的情况下获取档案。  </p>
<p>客户端仅通过接口与集合和迭代器交互，也就不会同具体类耦合。如果你决定将应用连接到全新的社交网络，只需提供新的集合和迭代器类即可，无需修改现有代码。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//集合接口必须声明一个用于生成迭代器的工厂方法。如果程序中有不同类型的迭代器，你也可以声明多个方法。</span></span><br><span class="line"><span class="keyword">interface</span> <span class="title class_">SocialNetwork</span> is</span><br><span class="line">	method <span class="title function_">createFriendsIterator</span><span class="params">(profileId)</span>:ProfileIterator</span><br><span class="line">	method <span class="title function_">createCoworkersIterator</span><span class="params">(profileId)</span>:ProfileIterator</span><br><span class="line">	</span><br><span class="line">	</span><br><span class="line"><span class="comment">//每个具体集合都与其返回的一组具体迭代器相耦合。但客户并不是这样的，因为这些方法的签名将会返回迭代器接口。</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">WeChat</span> <span class="keyword">implements</span> <span class="title class_">SocialNetwork</span> is</span><br><span class="line">	<span class="comment">// ...大量的集合代码应该放在这里</span></span><br><span class="line">	</span><br><span class="line">	<span class="comment">// 迭代器创建代码。</span></span><br><span class="line">	method <span class="title function_">createFriendsIterator</span><span class="params">(profileId)</span> is</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">WeChatIterator</span>(<span class="built_in">this</span>, profileId,，<span class="string">&quot;friends&quot;</span>)</span><br><span class="line">  method <span class="title function_">createCoworkersIterator</span><span class="params">(profileId)</span> is</span><br><span class="line">  	<span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">WeChatIterator</span>(<span class="built_in">this</span>, profileId, <span class="string">&quot;coworkers&quot;</span>)</span><br><span class="line">  </span><br><span class="line"><span class="comment">//所有选代器的通用接口。</span></span><br><span class="line"><span class="keyword">interface</span> <span class="title class_">ProfileIterator</span> is</span><br><span class="line">  method <span class="title function_">getNext</span><span class="params">()</span>:Profile</span><br><span class="line">  method <span class="title function_">hasMore</span><span class="params">()</span>:bool</span><br><span class="line">  </span><br><span class="line"><span class="comment">//具体选代器类。</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">WeChatIterator</span> <span class="keyword">implements</span> <span class="title class_">ProfileIterator</span> is</span><br><span class="line">  <span class="comment">//选代器需要一个指向其遍历集合的引用。</span></span><br><span class="line">  <span class="keyword">private</span> field weChat: WeChat</span><br><span class="line">  <span class="keyword">private</span> field profileId, type: string</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">  <span class="comment">//选代器对象会独立于其他选代器来对集合进行遍历。因此它必须保存迭代器的状态。	</span></span><br><span class="line">  <span class="keyword">private</span> field currentPosition</span><br><span class="line">  <span class="keyword">private</span> field cache: array of Profile</span><br><span class="line">    </span><br><span class="line">  constructor <span class="title function_">WeChatIterator</span><span class="params">(weChat, profileId, type)</span> is</span><br><span class="line">    <span class="built_in">this</span>.weChat = weChat</span><br><span class="line">    <span class="built_in">this</span>.profileId = profileId</span><br><span class="line">    <span class="built_in">this</span>.type = type</span><br><span class="line">    </span><br><span class="line">  <span class="keyword">private</span> method <span class="title function_">lazyInit</span><span class="params">()</span> is</span><br><span class="line">    <span class="title function_">if</span> <span class="params">(cache == <span class="literal">null</span>)</span></span><br><span class="line">      cache = weChat.socialGraphRequest(profileId, type)</span><br><span class="line">      </span><br><span class="line"><span class="comment">//每个具体选代器类都会自行实现通用选代器接口。</span></span><br><span class="line">  method <span class="title function_">getNext</span><span class="params">()</span> is</span><br><span class="line">     <span class="title function_">if</span> <span class="params">(hasMore()</span>)</span><br><span class="line">       currentPosition++</span><br><span class="line">     <span class="keyword">return</span> cache[currentPosition]</span><br><span class="line">       </span><br><span class="line">	method <span class="title function_">hasMore</span><span class="params">()</span> is</span><br><span class="line">     <span class="title function_">lazyInit</span><span class="params">()</span></span><br><span class="line">     <span class="keyword">return</span> currentPosition &lt; cache.length</span><br><span class="line">       </span><br><span class="line"><span class="comment">// 这里还有一个有用的绝招：你可将选代器传递给客户端类，无需让其拥有访问整个集合的权限。这样一来，你就无需将集合暴露给客户端了。</span></span><br><span class="line">       </span><br><span class="line"><span class="comment">// 还有另一个好处：你可在运行时将不同的选代器传递给客户端，从而改变客户端与集合互动的方式。这一方法可行的原因是客户端代码并没有和具体迭代器类相耦合。</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">SocialSpammer</span> is</span><br><span class="line">  method <span class="title function_">send</span><span class="params">(iterator: ProfileIterator, message: string)</span> is</span><br><span class="line">  	<span class="title function_">while</span> <span class="params">(iterator.hasMore()</span>)</span><br><span class="line">      profile = iterator.getNext()</span><br><span class="line">      System.sendEmail(profile.getEmail(), message)</span><br><span class="line">      </span><br><span class="line">      </span><br><span class="line"><span class="comment">//应用程序（Application）类可对集合和选代器进行配置，然后将其传递给客户端代码。</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Application</span> is</span><br><span class="line">  field network: SocialNetwork</span><br><span class="line">  field spammer: SocialSpammer</span><br><span class="line">    </span><br><span class="line">  method <span class="title function_">config</span><span class="params">()</span> is</span><br><span class="line">    <span class="keyword">if</span> working with WeChat</span><br><span class="line">      <span class="built_in">this</span>.network = <span class="keyword">new</span> <span class="title class_">WeChat</span>()</span><br><span class="line">  	<span class="keyword">if</span> working with LinkedIn</span><br><span class="line">      <span class="built_in">this</span>.network = <span class="keyword">new</span> <span class="title class_">LinkedIn</span>()</span><br><span class="line">    <span class="built_in">this</span>.spammer = <span class="keyword">new</span> <span class="title class_">Socialspammer</span>()</span><br><span class="line">      </span><br><span class="line">  method <span class="title function_">sendSpamToFriends</span><span class="params">(profile)</span> <span class="type">is</span></span><br><span class="line">    <span class="variable">iterator</span> <span class="operator">=</span> network.createFriendsIterator(profile.getId())</span><br><span class="line">    spammer.send（iterator，<span class="string">&quot;非常重要的消息&quot;</span>）</span><br><span class="line">      </span><br><span class="line">	method <span class="title function_">sendSpamToCoworkers</span><span class="params">(profile)</span> <span class="type">is</span></span><br><span class="line">    <span class="variable">iterator</span> <span class="operator">=</span> network.createCoworkersIterator(profile.getId())</span><br><span class="line">    spammer.send（iterator，<span class="string">&quot;非常重要的消息&quot;</span>）</span><br></pre></td></tr></table></figure>
<h3 id="应用场景-2"><a href="#应用场景-2" class="headerlink" title="应用场景"></a>应用场景</h3><ul>
<li><p>当集合背后为复杂的数据结构，且你希望对客户端隐藏其复杂性时（出于使用便利性或安全性的考虑），可以使用迭代器模式。</p>
<p>迭代器封装了与复杂数据结构进行交互的细节，为客户端提供多个访问集合元素的简单方法。这种方式不仅对客户端来说非常方便，而且能避免客户端在直接与集合交互时执行错误或有害的操作，从而起到保护集合的作用</p>
</li>
<li><p>使用该模式可以减少程序中重复的遍历代码</p>
<p>重要迭代算法的代码往往体积非常庞大。当这些代码被放置在程序业务逻辑中时，它会让原始代码的职责模糊不清，降低其可维护性。因此，将遍历代码移到特定的迭代器中可使程序代码更加精炼和简洁。</p>
</li>
<li><p>如果你希望代码能够遍历不同的甚至是无法预知的数据结构，可以使用迭代器模式</p>
<p>该模式为集合和迭代器提供了一些通用接口。如果你在代码中使用了这些接口，那么将其他实现了这些接口的集合和迭代器传递给它时，它仍将可以正常运行。</p>
</li>
</ul>
<h3 id="实现方式-2"><a href="#实现方式-2" class="headerlink" title="实现方式"></a>实现方式</h3><ol>
<li>声明迭代器接口。该接口必须提供至少一个方法来获取集合中的下个元素。但为了使用方便，你还可以添加一些其他方法，例如获取前一个元素、记录当前位置和判断迭代是否已结束。</li>
<li>声明集合接口并描述一个获取迭代器的方法。其返回值必须是迭代器接口。如果你计划拥有多组不同的迭代器，则可以声明多个类似的方法。</li>
<li>为希望使用迭代器进行遍历的集合实现具体迭代器类。迭代器对象必须与单个集合实体链接。链接关系通常通过迭代器的构造函数建立。</li>
<li>在你的集合类中实现集合接口。其主要思想是针对特定集合为客户端代码提供创建迭代器的快捷方式。集合对象必须将自身传递给迭代器的构造函数来创建两者之间的链接。</li>
<li>检查客户端代码，使用迭代器替代所有集合遍历代码。每当客户端需要遍历集合元素时都会获取一个新的迭代器。</li>
</ol>
<h3 id="优缺点-2"><a href="#优缺点-2" class="headerlink" title="优缺点"></a>优缺点</h3><ul>
<li>单一职责原则。通过将体积庞大的遍历算法代码抽取为独立的类，你可对客户端代码和集合进行整理</li>
<li>开闭原则。你可实现新型的集合和迭代器并将其传递给现有代码，无需修改现有代码。</li>
<li>你可以并行遍历同一集合，因为每个迭代器对象都包含其自身的遍历状态。</li>
<li>相似的，你可以暂停遍历并在需要时继续。</li>
</ul>
<hr>
<ul>
<li>如果你的程序只与简单的集合进行交互，应用该模式可能会矫枉过正。</li>
<li>对于某些特殊集合，使用迭代器可能比直接遍历的效率低。</li>
</ul>
<h3 id="与其他模式的关系-2"><a href="#与其他模式的关系-2" class="headerlink" title="与其他模式的关系"></a>与其他模式的关系</h3><ul>
<li>你可以使用迭代器来遍历组合树</li>
<li>你可以同时使用工厂方法和迭代器来让子类集合返回不同类型的迭代器，并使得迭代器与集合相匹配</li>
<li>你可以同时使用备忘录和迭代器来获取当前迭代器的状态，并且在需要的时候进行回滚。</li>
<li>可以同时使用访问者和迭代器来遍历复杂数据结构，并对其中的元素执行所需操作，即使这些元素所属的类完全不同。  </li>
</ul>
<h2 id="中介者"><a href="#中介者" class="headerlink" title="中介者"></a>中介者</h2><blockquote>
<p>调解人、控制器、Intermediary、Controller、Mediator</p>
</blockquote>
<p>中介者是一种行为设计模式，能让你减少对象之间混乱无序的依赖关系。该模式会限制对象之间的直接交互，迫使它们通过一个中介者对象　　进行合作。</p>
<h3 id="问题背景-3"><a href="#问题背景-3" class="headerlink" title="问题背景"></a>问题背景</h3><p>假如你有一个创建和修改客户资料的对话框，它由各种控件组成， 例如文本框（TextField）、 复选框（<code>Checkbox</code>）和按钮（<code>Button</code>）等。</p>
<p><img src="/posts/23570/image-20240422190409968.png" alt="image-20240422190409968"></p>
<p>某些表单元素可能会直接进行互动。例如，选中“我有一只狗”复选框后可能会显示一个隐藏文本框用于输入狗狗的名字。另一个例子是提交按钮必须在保存数据前校验所有输入内容。</p>
<p><img src="/posts/23570/image-20240422191038669.png" alt="image-20240422191038669"></p>
<p>元素间存在许多关联。因此，对某些元素进行修改可能会影响其他元素。</p>
<p>如果直接在表单元素代码中实现业务逻辑，你将很难在程序其他表单中复用这些元素类。例如，由于复选框类与狗狗的文本框相耦合，所以将无法在其他表单中使用它。你要么使用渲染资料表单时用到的所有类，要么一个都不用  </p>
<h3 id="解决方案-3"><a href="#解决方案-3" class="headerlink" title="解决方案"></a>解决方案</h3><p>中介者模式建议你停止组件之间的直接交流并使其相互独立。这些组件必须调用特殊的中介者对象，通过中介者对象重定向调用行为，以间接的方式进行合作。最终，组件仅依赖于一个中介者类，无需与多个其他组件相耦合。</p>
<p>在资料编辑表单的例子中，对话框（Dialog）类本身将作为中介者，其很可能已知自己所有的子元素，因此你甚至无需在该类中引入新的依赖关系。</p>
<p><img src="/posts/23570/image-20240422192149797.png" alt="image-20240422192149797"></p>
<p>绝大部分重要的修改都在实际表单元素中进行。让我们想想提交按钮。之前，当用户点击按钮后，它必须对所有表单元素数值进行校验。而现在它的唯一工作是将点击事件通知给对话框。收到通知后，对话框可以自行校验数值或将任务委派给各元素。这样一来，按钮不再与多个表单元素相关联，而仅依赖于对话框类。</p>
<p>你还可以为所有类型的对话框抽取通用接口，进一步削弱其依赖性。接口中将声明一个所有表单元素都能使用的通知方法，可用于将元素中发生的事件通知给对话框。这样一来，所有实现了该接口的对话框都能使用这个提交按钮了。</p>
<p>采用这种方式，中介者模式让你能在单个中介者对象中封装多个对象间的复杂关系网。类所拥有的依赖关系越少，就越易于修改、扩展或复用。</p>
<h3 id="结构-3"><a href="#结构-3" class="headerlink" title="结构"></a>结构</h3><p><img src="/posts/23570/image-20240423100304200.png" alt="image-20240423100304200" style="zoom: 33%;"></p>
<ol>
<li><p>组件（Component）是各种包含业务逻辑的类。每个组件都有一个指向中介者的引用，该引用被声明为中介者接口类型。组件不知道中介者实际所属的类，因此你可通过将其连接到不同的中介者以使其能在其他程序中复用。</p>
</li>
<li><p>中介者（Mediator）接口声明了与组件交流的方法，但通常仅包括一个通知方法。组件可将任意上下文（包括自己的对象）作为该方法的参数，只有这样接收组件和发送者类之间才不会耦合。</p>
</li>
<li><p>具体中介者（Concrete Mediator）封装了多种组件间的关系。具体中介者通常会保存所有组件的引用并对其进行管理，甚至有时会对其生命周期进行管理。</p>
</li>
<li><p>组件并不知道其他组件的情况。如果组件内发生了重要事件，它只能通知中介者。中介者收到通知后能轻易地确定发送者，这或许已足以判断接下来需要触发的组件了。</p>
<p>对于组件来说，中介者看上去完全就是一个黑箱。发送者不知道最终会由谁来处理自己的请求，接收者也不知道最初是谁发出了请求。  </p>
</li>
</ol>
<h3 id="伪代码-3"><a href="#伪代码-3" class="headerlink" title="伪代码"></a>伪代码</h3><p>中介者模式可帮助你减少各种 UI 类（按钮、复选框和文本标签）之间的相互依赖关系。</p>
<p><img src="/posts/23570/image-20240423101135481.png" alt="image-20240423101135481" style="zoom:33%;"></p>
<p>用户触发的元素不会直接与其他元素交流，即使看上去它们应该这样做。相反，元素只需让中介者知晓事件即可，并能在发出通知时同时传递任何上下文信息。</p>
<p>本例中的中介者是整个认证对话框。对话框知道具体元素应如何进行合作并促进它们的间接交流。当接收到事件通知后，对话框会确定负责处理事件的元素并据此重定向请求。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//中介者接口声明了一个能让组件将各种事件通知给中介者的方法。中介者可对这些事件做出响应并将执行工作传递给其他组件。</span></span><br><span class="line"><span class="keyword">interface</span> <span class="title class_">Mediator</span> is</span><br><span class="line">	method <span class="title function_">notify</span><span class="params">(sender: Component, event: string)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//具体中介者类可解开各组件之间相互交叉的连接关系并将其转移到中介者中。</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">AuthenticationDialog</span> <span class="keyword">implements</span> <span class="title class_">Mediator</span> is</span><br><span class="line">	<span class="keyword">private</span> field title: string</span><br><span class="line">	<span class="keyword">private</span> field loginorRegisterChkBx: Checkbox</span><br><span class="line">	<span class="keyword">private</span> field loginUsername, loginPassword: Textbox</span><br><span class="line">	<span class="keyword">private</span> field registrationUsername, registrationPassword,registrationEmail: Textbox</span><br><span class="line">	<span class="keyword">private</span> field okBtn, cancelBtn: Button</span><br><span class="line">	</span><br><span class="line">	constructor <span class="title function_">AuthenticationDialog</span><span class="params">()</span> is</span><br><span class="line">		<span class="comment">//创建所有组件对象并将当前中介者传递给其构造函数以建立连接。</span></span><br><span class="line">		</span><br><span class="line"><span class="comment">//当组件中有事件发生时，它会通知中介者。中介者接收到通知后可自行处理，也可将请求传递给另一个组件。</span></span><br><span class="line"></span><br><span class="line">	method <span class="title function_">notify</span><span class="params">(sender, event)</span> is</span><br><span class="line">		<span class="title function_">if</span> <span class="params">(sender == loginorRegisterChkBx and event == <span class="string">&quot;check&quot;</span>)</span></span><br><span class="line">			<span class="keyword">if</span> (loginOrRegisterChkBx.checked)</span><br><span class="line">				title = <span class="string">&quot;登录&quot;</span></span><br><span class="line">				<span class="comment">//1，显示登录表单组件。</span></span><br><span class="line">				<span class="comment">//2. 隐藏注册表单组件。</span></span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">      	title=“注册<span class="string">&quot;</span></span><br><span class="line"><span class="string">      	//1，显示注册表单组件。</span></span><br><span class="line"><span class="string">      	//2. 隐藏登录表单组件。</span></span><br><span class="line"><span class="string">      if (sender == okBtn &amp;&amp; event == &quot;</span>click<span class="string">&quot;)</span></span><br><span class="line"><span class="string">      	if ( loginOrRegister.checked)</span></span><br><span class="line"><span class="string">      		//尝试找到使用登录信息的用户。</span></span><br><span class="line"><span class="string">      		if (!found)</span></span><br><span class="line"><span class="string">      			// 在登录字段上方显示错误信息。</span></span><br><span class="line"><span class="string">      		else</span></span><br><span class="line"><span class="string">      			//1. 使用注册字段中的数据创建用户账号。</span></span><br><span class="line"><span class="string">      			</span></span><br><span class="line"><span class="string">//组件会使用中介者接口与中介者进行交互。因此只需将它们与不同的中介者连接起来，你就能在其他情境中使用这些组件了。</span></span><br><span class="line"><span class="string">class Component isfield dialog: Mediator</span></span><br><span class="line"><span class="string">	constructor Component(dialog)is</span></span><br><span class="line"><span class="string">		this.dialog = dialog</span></span><br><span class="line"><span class="string">  method click() is</span></span><br><span class="line"><span class="string">  	dialog.notify(this, &quot;</span>click<span class="string">&quot;)</span></span><br><span class="line"><span class="string">  method keypress() is</span></span><br><span class="line"><span class="string">  	dialog.notify(this, &quot;</span>keypress<span class="string">&quot;)</span></span><br><span class="line"><span class="string">  	</span></span><br><span class="line"><span class="string">//具体组件之间无法进行交流。它们只有一个交流渠道，那就是向中介者发送通知。</span></span><br><span class="line"><span class="string">class Button extends Component is</span></span><br><span class="line"><span class="string">	// ...</span></span><br><span class="line"><span class="string">	</span></span><br><span class="line"><span class="string">class Textbox extends Component is</span></span><br><span class="line"><span class="string">	// ...</span></span><br><span class="line"><span class="string">	</span></span><br><span class="line"><span class="string">class Checkbox extends Component is</span></span><br><span class="line"><span class="string">	method check() is</span></span><br><span class="line"><span class="string">		dialog.notify(this, &quot;</span>check<span class="string">&quot;)</span></span><br><span class="line"><span class="string">  // ...</span></span><br></pre></td></tr></table></figure>
<h3 id="应用场景-3"><a href="#应用场景-3" class="headerlink" title="应用场景"></a>应用场景</h3><ul>
<li><p>当一些对象和其他对象紧密耦合以致难以对其进行修改时，可使用中介者模式</p>
<p>该模式让你将对象间的所有关系抽取成为一个单独的类，以使对于特定组件的修改工作独立于其他组件</p>
</li>
<li><p>当组件因过于依赖其他组件而无法在不同应用中复用时，可使用中介者模式</p>
<p>应用中介者模式后，每个组件不再知晓其他组件的情况。尽管这些组件无法直接交流，但它们仍可通过中介者对象进行间接交流。如果你希望在不同应用中复用一个组件，则需要为其提供一个新的中介者类  </p>
</li>
<li><p>如果为了能在不同情景下复用一些基本行为，导致你需要被迫创建大量组件子类时，可使用中介者模式</p>
<p>由于所有组件间关系都被包含在中介者中，因此你无需修改组件就能方便地新建中介者类以定义新的组件合作方式</p>
</li>
</ul>
<h3 id="实现方式-3"><a href="#实现方式-3" class="headerlink" title="实现方式"></a>实现方式</h3><ol>
<li>找到一组当前紧密耦合，且提供其独立性能带来更大好处的类（例如更易于维护或更方便复用）</li>
<li>声明中介者接口并描述中介者和各种组件之间所需的交流接口。在绝大多数情况下，一个接收组件通知的方法就足够了。如果你希望在不同情景下复用组件类，那么该接口将非常重要。只要组件使用通用接口与其中介者合作，你就能将该组件与不同实现中的中介者进行连接。</li>
<li>实现具体中介者类。该类可从自行保存其下所有组件的引用中受益。  </li>
<li>你可以更进一步，让中介者负责组件对象的创建和销毁。此后，中介者可能会与工厂或外观类似。  </li>
<li>组件必须保存对于中介者对象的引用。该连接通常在组件的构造函数中建立，该函数会将中介者对象作为参数传递。</li>
<li>修改组件代码，使其可调用中介者的通知方法，而非其他组件的方法。 然后将调用其他组件的代码抽取到中介者类中，并在中介者接收到该组件通知时执行这些代码。  </li>
</ol>
<h3 id="优缺点-3"><a href="#优缺点-3" class="headerlink" title="优缺点"></a>优缺点</h3><ul>
<li>单一职责原则。你可以将多个组件间的交流抽取到同一位置，使其更易于理解和维护。</li>
<li>开闭原则。你无需修改实际组件就能增加新的中介者。</li>
<li>你可以减轻应用中多个组件间的耦合情况</li>
<li>你可以更方便地复用各个组件</li>
</ul>
<hr>
<ul>
<li>一段时间后，中介者可能会演化成为上帝对象</li>
</ul>
<h3 id="与其他模式的关系-3"><a href="#与其他模式的关系-3" class="headerlink" title="与其他模式的关系"></a>与其他模式的关系</h3><ul>
<li><p>责任链、命令、中介者和观察者用于处理请求发送者和接收者之间的不同连接方式：</p>
<ul>
<li>责任链按照顺序将请求动态传递给一系列的潜在接收者，直至其中一名接收者对请求进行处理。</li>
<li>命令在发送者和请求者之间建立单向连接。</li>
<li>中介者清除了发送者和请求者之间的直接连接，强制它们通过一个中介对象进行间接沟通。</li>
<li>观察者允许接收者动态地订阅或取消接收请求  </li>
</ul>
</li>
<li><p>外观和中介者的职责类似：它们都尝试在大量紧密耦合的类中组织起合作。</p>
<ul>
<li>外观为子系统中的所有对象定义了一个简单接口，但是它不提供任何新功能。子系统本身不会意识到外观的存在。子系统中的对象可以直接进行交流。</li>
<li>中介者将系统中组件的沟通行为中心化。各组件只知道中介者对象，无法直接相互交流。</li>
</ul>
</li>
<li><p>中介者和观察者之间的区别往往很难记住。在大部分情况下，你可以使用其中一种模式，而有时可以同时使用。让我们来看看如何做到这一点。  </p>
<p>中介者的主要目标是消除一系列系统组件之间的相互依赖。这些组件将依赖于同一个中介者对象。观察者的目标是在对象之间建立动态的单向连接，使得部分对象可作为其他对象的附属发挥作用。  </p>
<p>有一种流行的中介者模式实现方式依赖于观察者。中介者对象担当发布者的角色，其他组件则作为订阅者，可以订阅中介者的事件或取消订阅。当中介者以这种方式实现时，它可能看上去与观察者非常相似  </p>
<p>当你感到疑惑时，记住可以采用其他方式来实现中介者。例如，你可永久性地将所有组件链接到同一个中介者对象。这种实现方式和观察者并不相同，但这仍是一种中介者模式</p>
<p>假设有一个程序，其所有的组件都变成了发布者，它们之间可以相互建立动态连接。这样程序中就没有中心化的中介者对象，而只有一些分布式的观察者。</p>
</li>
</ul>
<h2 id="备忘录"><a href="#备忘录" class="headerlink" title="备忘录"></a>备忘录</h2><blockquote>
<p>快照、Snapshot、Memento</p>
</blockquote>
<p>备忘录是一种行为设计模式，允许在不暴露对象实现细节的情况下保存和恢复对象之前的状态</p>
<h3 id="问题背景-4"><a href="#问题背景-4" class="headerlink" title="问题背景"></a>问题背景</h3><p>假如你正在开发一款文字编辑器应用程序。除了简单的文字编辑功能外，编辑器中还要有设置文本格式和插入内嵌图片等功能。</p>
<p>后来，你决定让用户能撤销施加在文本上的任何操作。这项功能在过去几年里变得十分普遍，因此用户期待任何程序都有这项功能。你选择采用直接的方式来实现该功能：程序在执行任何操作前会记录所有的对象状态， 并将其保存下来。当用户此后需要撤销某个操作时，程序将从历史记录中获取最近的快照，然后使用它来恢复所有对象的状态。</p>
<p><img src="/posts/23570/image-20240508182231899-1715163766878-1.png" alt="image-20240508182231899"></p>
<p>首先，到底该如何生成一个快照呢？很可能你会需要遍历对象的所有成员变量并将其数值复制保存。但只有当对象对其内容没有严格访问权限限制的情况下，你才能使用该方式。不过很遗憾，绝大部分对象会使用私有成员变量来存储重要数据，这样别人就无法轻易查看其中的内容。  </p>
<p>即使不考虑访问权限问题，通过上述方式虽然能够随时生成对象的快照，但是依然存在一些严重问题。</p>
<p>未来你可能会添加或删除一些成员变量。这听上去很简单，但需要对负责复制受影响对象状态的类进行更改  </p>
<p>此外，让我们来考虑编辑器（Editor）状态的实际“快照”， 它需要包含哪些数据？ 至少必须包含实际的文本、光标坐标和当前滚动条位置等。你需要收集这些数据并将其放入特定容器中，才能生成快照。  </p>
<p>为了让其他对象能保存或读取快照，你很可能需要将快照的成员变量设为公有。无论这些状态是否私有，其都将暴露一切编辑器状态。其他类会对快照类的每个小改动产生依赖，除非这些改动仅存在于私有成员变量或方法中，而不会影响外部类。</p>
<p>我们似乎走进了一条死胡同：要么会暴露类的所有内部细节而使其过于脆弱；要么会限制对其状态的访问权限而无法生成快照。那么，我们还有其他方式来实现“撤销”功能吗？</p>
<h3 id="解决方案-4"><a href="#解决方案-4" class="headerlink" title="解决方案"></a>解决方案</h3><p>备忘录模式将创建状态快照（Snapshot）的工作委派给实际状态的拥有者原发器（Originator）对象。这样其他对象就不再需要从“外部”复制编辑器状态了，编辑器类拥有其状态的完全访问权，因此可以自行生成快照。</p>
<p>该模式建议将对象状态的副本存储在一个名为备忘录（Memento）的特殊对象中。除了创建备忘录的对象外，任何对象都不能访问备忘录的内容。其他对象必须使用受限接口与备忘录进行交互，它们可以获取快照的元数据（创建时间和操作名称等），但不能获取快照中原始对象的状态。</p>
<p><img src="/posts/23570/image-20240508183247912.png" alt="image-20240508183247912" style="zoom:33%;"></p>
<p>这种限制策略允许你将备忘录保存在通常被称为负责人（Caretakers）的对象中。由于负责人仅通过受限接口与备忘录互动，故其无法修改存储在备忘录内部的状态。同时，原发器拥有对备忘录所有成员的访问权限，从而能随时恢复其以前的状态</p>
<p>在文字编辑器的示例中， 我们可以创建一个独立的历史（History）类作为负责人。编辑器每次执行操作前，存储在负责人中的备忘录栈都会生长。你甚至可以在应用的 UI 中渲染该栈，为用户显示之前的操作历史。</p>
<p>当用户触发撤销操作时，历史类将从栈中取回最近的备忘录，并将其传递给编辑器以请求进行回滚。由于编辑器拥有对备忘录的完全访问权限，因此它可以使用从备忘录中获取的数值来替换自身的状态</p>
<h3 id="结构-4"><a href="#结构-4" class="headerlink" title="结构"></a>结构</h3><h4 id="基于嵌套类的实现"><a href="#基于嵌套类的实现" class="headerlink" title="基于嵌套类的实现"></a>基于嵌套类的实现</h4><p><img src="/posts/23570/image-20240508184044562.png" alt="image-20240508184044562"></p>
<ol>
<li><p>原发器（Originator）类可以生成自身状态的快照，也可以在<br>需要时通过快照恢复自身状态。</p>
</li>
<li><p>备忘录 （Memento） 是原发器状态快照的值对象 （valueobject）。通常做法是将备忘录设为不可变的，并通过构造函数一次性传递数据。</p>
</li>
<li><p>负责人（Caretaker）仅知道“何时”和“为何”捕捉原发器的状态，以及何时恢复状态。</p>
<p>负责人通过保存备忘录栈来记录原发器的历史状态。当原发器需要回溯历史状态时，负责人将从栈中获取最顶部的备忘录，并将其传递给原发器的恢复（restoration）方法。  </p>
</li>
<li><p>在该实现方法中，备忘录类将被嵌套在原发器中。这样原发器就可访问备忘录的成员变量和方法，即使这些方法被声明为私有。另一方面，负责人对于备忘录的成员变量和方法的访问权限非常有限：它们只能在栈中保存备忘录，而不能修改其状态。  </p>
</li>
</ol>
<h3 id="伪代码-4"><a href="#伪代码-4" class="headerlink" title="伪代码"></a>伪代码</h3><p>本例结合使用了命令模式与备忘录模式，可保存复杂文字编辑器的状态快照，并能在需要时从快照中恢复之前的状态。</p>
<p><img src="/posts/23570/image-20240508184338773.png" alt="image-20240508184338773"></p>
<p>命令（command）对象将作为负责人，它们会在执行与命令相关的操作前获取编辑器的备忘录。当用户试图撤销最近的命令时，编辑器可以使用保存在命令中的备忘录来将自身回滚到之前的状态。</p>
<p>备忘录类没有声明任何公有的成员变量、 获取器（getter）和设置器，因此没有对象可以修改其内容。备忘录与创建自己的编辑器相连接，这使得备忘录能够通过编辑器对象的设置器传递数据，恢复与其相连接的编辑器的状态。由于备忘录与特定的编辑器对象相连接，程序可以使用中心化的撤销栈实现对多个独立编辑器窗口的支持。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//原发器中包含了一些可能会随时间变化的重要数据。它还定义了在备忘录中保存自身状态的方法，以及从备忘录中恢复状态的方法。</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Editor</span> is</span><br><span class="line">  <span class="keyword">private</span> field text, curX, curY, selectionWidth</span><br><span class="line">  method <span class="title function_">setText</span><span class="params">(text)</span> is</span><br><span class="line">  	<span class="built_in">this</span>.text = text</span><br><span class="line">  </span><br><span class="line">  method <span class="title function_">setCursor</span><span class="params">(x, y)</span> is</span><br><span class="line">  	<span class="built_in">this</span>.curX = X</span><br><span class="line">   	<span class="built_in">this</span>.curY = y</span><br><span class="line">  </span><br><span class="line">  method <span class="title function_">setSelectionWidth</span><span class="params">(width)</span> is</span><br><span class="line">  	<span class="built_in">this</span>.selectionWidth = width</span><br><span class="line">  </span><br><span class="line">  <span class="comment">//在备忘录中保存当前的状态。</span></span><br><span class="line">  method <span class="title function_">createSnapshot</span><span class="params">()</span>:Snapshot is</span><br><span class="line">  <span class="comment">//备忘录是不可变的对象；因此原发器会将自身状态作为参数传递给备忘录的构造函数。</span></span><br><span class="line">  	<span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Snapshot</span>(<span class="built_in">this</span>, text, curX, curY, selectionWidth)</span><br><span class="line">  </span><br><span class="line"><span class="comment">//备忘录类保存有编辑器的过往状态。</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Snapshot</span> is</span><br><span class="line">  <span class="keyword">private</span> field editor: Editor</span><br><span class="line">  <span class="keyword">private</span> field text, curX, curY, selectionWidth</span><br><span class="line">    </span><br><span class="line">  constructor <span class="title function_">Snapshot</span><span class="params">(editor, text, curX, curY， selectionWidth)</span> is</span><br><span class="line">  	<span class="built_in">this</span>.editor = editor</span><br><span class="line">    <span class="built_in">this</span>.text = text</span><br><span class="line">    <span class="built_in">this</span>.curX = x</span><br><span class="line">    <span class="built_in">this</span>.curY = y</span><br><span class="line">    <span class="built_in">this</span>.selectionWidth = selectionWidth</span><br><span class="line">    </span><br><span class="line"><span class="comment">// 在某一时刻，编辑器之前的状态可以使用备忘录对象来恢复。</span></span><br><span class="line">	method <span class="title function_">restore</span><span class="params">()</span> is</span><br><span class="line">    editor.setText(text)</span><br><span class="line">    editor.setCursor(curX, curY)</span><br><span class="line">    editor.setSelectionWidth(selectionWidth)</span><br><span class="line">    </span><br><span class="line"><span class="comment">// 命令对象可作为负责人。在这种情况下，命令会在修改原发器状态之前获取一个备忘录。当需要撤销时，它会从备忘录中恢复原发器的状态。</span></span><br><span class="line">  <span class="keyword">class</span> <span class="title class_">Command</span> is</span><br><span class="line">    <span class="keyword">private</span> field backup: Snapshot</span><br><span class="line">        </span><br><span class="line">    method <span class="title function_">makeBackup</span><span class="params">()</span> <span class="type">is</span></span><br><span class="line">      <span class="variable">backup</span> <span class="operator">=</span> editor.createSnapshot()</span><br><span class="line">      </span><br><span class="line">    method <span class="title function_">undo</span><span class="params">()</span> is</span><br><span class="line">      <span class="title function_">if</span> <span class="params">(backup != <span class="literal">null</span>)</span></span><br><span class="line">        backup.restore()</span><br><span class="line"> <span class="comment">// ...</span></span><br></pre></td></tr></table></figure>
<h3 id="应用场景-4"><a href="#应用场景-4" class="headerlink" title="应用场景"></a>应用场景</h3><ul>
<li><p><strong>当你需要创建对象状态快照来恢复其之前的状态时，可以使用备忘录模式。</strong>  </p>
<p>备忘录模式允许你复制对象中的全部状态（包括私有成员变量），并将其独立于对象进行保存。尽管大部分人因为“撤销”这个用例才记得该模式，但其实它在处理事务（比如需要在出现错误时回滚一个操作）的过程中也必不可少。  </p>
</li>
<li><p><strong>当直接访问对象的成员变量、获取器或设置器将导致封装被突破时，可以使用该模式。</strong>  </p>
<p>备忘录让对象自行负责创建其状态的快照。任何其他对象都不能读取快照，这有效地保障了数据的安全性。</p>
</li>
</ul>
<h3 id="实现方式-4"><a href="#实现方式-4" class="headerlink" title="实现方式"></a>实现方式</h3><ol>
<li><p>确定担任原发器角色的类。重要的是明确程序使用的一个原发器中心对象，还是多个较小的对象。</p>
</li>
<li><p>创建备忘录类。逐一声明对应每个原发器成员变量的备忘录成员变量。  </p>
</li>
<li><p>将备忘录类设为不可变。备忘录只能通过构造函数一次性接收数据。该类中不能包含设置器。</p>
</li>
<li><p>如果你所使用的编程语言支持嵌套类，则可将备忘录嵌套在原发器中；如果不支持，那么你可从备忘录类中抽取一个空接口，然后让其他所有对象通过接口来引用备忘录。你可在该接口中添加一些元数据操作，但不能暴露原发器的状态。</p>
</li>
<li><p>在原发器中添加一个创建备忘录的方法。原发器必须通过备忘录构造函数的一个或多个实际参数来将自身状态传递给备忘录。</p>
<p>该方法返回结果的类型必须是你在上一步中抽取的接口（如果你已经抽取了）。实际上，创建备忘录的方法必须直接与备忘录类进行交互。  </p>
</li>
<li><p>在原发器类中添加一个用于恢复自身状态的方法。该方法接受备忘录对象作为参数。如果你在之前的步骤中抽取了接口，那么可将接口作为参数的类型。在这种情况下，你需要将输入对象强制转换为备忘录，因为原发器需要拥有对该对象的完全访问权限。</p>
</li>
<li><p>无论负责人是命令对象、 历史记录或其他完全不同的东西，它都必须要知道何时向原发器请求新的备忘录、如何存储备忘录以及何时使用特定备忘录来对原发器进行恢复。  </p>
</li>
<li><p>负责人与原发器之间的连接可以移动到备忘录类中。在本例中，每个备忘录都必须与创建自己的原发器相连接。恢复方法也可以移动到备忘录类中，但只有当备忘录类嵌套在原发器中，或者原发器类提供了足够多的设置器并可对其状态进行重写时，这种方式才能实现。</p>
</li>
</ol>
<h3 id="优缺点-4"><a href="#优缺点-4" class="headerlink" title="优缺点"></a>优缺点</h3><ul>
<li>你可以在不破坏对象封装情况的前提下创建对象状态快照</li>
<li>你可以通过让负责人维护原发器状态历史记录来简化原发器代码</li>
</ul>
<hr>
<ul>
<li>如果客户端过于频繁地创建备忘录，程序将消耗大量内存</li>
<li>负责人必须完整跟踪原发器的生命周期，这样才能销毁弃用的备忘录</li>
<li>绝大部分动态编程语言（例如 PHP、 Python 和 JavaScript）不能确保备忘录中的状态不被修改</li>
</ul>
<h3 id="与其他模式的关系-4"><a href="#与其他模式的关系-4" class="headerlink" title="与其他模式的关系"></a>与其他模式的关系</h3><ul>
<li>你可以同时使用命令和备忘录来实现“撤销”。在这种情况下，命令用于对目标对象执行各种不同的操作，备忘录用来保存一条命令执行前该对象的状态。  </li>
<li>你可以同时使用备忘录和迭代器来获取当前迭代器的状态，并且在需要的时候进行回滚。</li>
<li>有时候原型可以作为备忘录的一个简化版本，其条件是你需要在历史记录中存储的对象的状态比较简单，不需要链接其他外部资源，或者链接可以方便地重建。</li>
</ul>
<h2 id="观察者"><a href="#观察者" class="headerlink" title="观察者"></a>观察者</h2><blockquote>
<p>事件订阅者、监听者、Event-Subscriber、Listener、Observer</p>
</blockquote>
<p>观察者是一种行为设计模式，允许你定义一种订阅机制，可在对象事件发生时通知多个“观察”该对象的其他对象。</p>
<h3 id="问题背景-5"><a href="#问题背景-5" class="headerlink" title="问题背景"></a>问题背景</h3><p>假如你有两种类型的对象： 顾客 和 商店 。顾客对某个特定品牌的产品非常感兴趣（例如最新型号的 iPhone 手机），而该产品很快将会在商店里出售。</p>
<p>顾客可以每天来商店看看产品是否到货。但如果商品尚未到货时，绝大多数来到商店的顾客都会空手而归。</p>
<p>另一方面，每次新产品到货时，商店可以向所有顾客发送邮件（可能会被视为垃圾邮件）。这样，部分顾客就无需反复前往商店了，但也可能会惹恼对新产品没有兴趣的其他顾客。</p>
<h3 id="解决方案-5"><a href="#解决方案-5" class="headerlink" title="解决方案"></a>解决方案</h3><p>拥有一些值得关注的状态的对象通常被称为目标，由于它要将自身的状态改变通知给其他对象，我们也将其称为发布者（publisher）。所有希望关注发布者状态变化的其他对象被称为订阅者（subscribers）。</p>
<p>观察者模式建议你为发布者类添加订阅机制，让每个对象都能订阅或取消订阅发布者事件流。该机制包括 1）一个用于存储订阅者对象引用的列表成员变量；2）几个用于添加或删除该列表中订阅者的公有方法。  </p>
<p><img src="/posts/23570/image-20240510183836914.png" alt="image-20240510183836914"></p>
<p>现在，无论何时发生了重要的发布者事件，它都要遍历订阅者并调用其对象的特定通知方法。</p>
<p>实际应用中可能会有十几个不同的订阅者类跟踪着同一个发布者类的事件， 你不会希望发布者与所有这些类相耦合的。</p>
<p>因此，所有订阅者都必须实现同样的接口，发布者仅通过该接口与订阅者交互。接口中必须声明通知方法及其参数，这样发布者在发出通知时还能传递一些上下文数据。</p>
<p><img src="/posts/23570/image-20240510184407098.png" alt="image-20240510184407098"></p>
<p>如果你的应用中有多个不同类型的发布者，且希望订阅者可兼容所有发布者，那么你甚至可以进一步让所有订阅者遵循同样的接口。该接口仅需描述几个订阅方法即可。这样订阅者就能在不与具体发布者类耦合的情况下通过接口观察发布者的状态。</p>
<h3 id="结构-5"><a href="#结构-5" class="headerlink" title="结构"></a>结构</h3><p><img src="/posts/23570/image-20240510184511992.png" alt="image-20240510184511992"></p>
<ol>
<li>发布者（Publisher）会向其他对象发送值得关注的事件。事件会在发布者自身状态改变或执行特定行为后发生。发布者中包含一个允许新订阅者加入和当前订阅者离开列表的订阅构架。</li>
<li>当新事件发生时，发送者会遍历订阅列表并调用每个订阅者对象的通知方法。该方法是在订阅者接口中声明的。</li>
<li>订阅者（Subscriber）接口声明了通知接口。 在绝大多数情况下，该接口仅包含一个 update 更新 方法。该方法可以拥有多个参数，使发布者能在更新时传递事件的详细信息。</li>
<li>具体订阅者（Concrete Subscribers）可以执行一些操作来回应发布者的通知。 所有具体订阅者类都实现了同样的接口，因此发布者不需要与具体类相耦合。</li>
<li>订阅者通常需要一些上下文信息来正确地处理更新。 因此，发布者通常会将一些上下文数据作为通知方法的参数进行传递。发布者也可将自身作为参数进行传递，使订阅者直接获取所需的数据。</li>
<li>客户端（Client）会分别创建发布者和订阅者对象，然后为订阅者注册发布者更新。</li>
</ol>
<h3 id="伪代码-5"><a href="#伪代码-5" class="headerlink" title="伪代码"></a>伪代码</h3><p>在本例中，观察者模式允许文本编辑器对象将自身的状态改变通知给其他服务对象。</p>
<p><img src="/posts/23570/image-20240510185054950.png" alt="image-20240510185054950"></p>
<p>订阅者列表是动态生成的：对象可在运行时根据程序需要开始或停止监听通知。</p>
<p>在本实现中，编辑器类自身并不维护订阅列表。它将工作委派给专门从事此工作的一个特殊帮手对象。你还可将该对象升级为中心化的事件分发器，允许任何对象成为发布者。</p>
<p>只要发布者通过同样的接口与所有订阅者进行交互，那么在程序中新增订阅者时就无需修改已有发布者类的代码。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//发布者基类包含订阅管理代码和通知方法。</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">EventManager</span> is</span><br><span class="line">	<span class="keyword">private</span> field listeners: hash map of event types and listeners</span><br><span class="line">	</span><br><span class="line">	method <span class="title function_">subscribe</span><span class="params">(eventType, listener） is</span></span><br><span class="line"><span class="params">		listeners.add(eventType, listener)</span></span><br><span class="line">		</span><br><span class="line">  method <span class="title function_">unsubscribe</span><span class="params">(eventType, listener)</span> is</span><br><span class="line">  	listeners.remove(eventType, listener)</span><br><span class="line">  	</span><br><span class="line">  method <span class="title function_">notify</span><span class="params">(eventType, data)</span> is</span><br><span class="line">  	<span class="title function_">foreach</span> <span class="params">(listener in listeners.of(eventType)</span>) <span class="keyword">do</span></span><br><span class="line">  		listener.update(data)</span><br><span class="line">                   </span><br><span class="line"><span class="comment">//具体发布者包含一些订阅者感兴趣的实际业务逻辑。我们可以从发布者基类中扩展出该类，但在实际情况下并不总能做到，因为具体发布者可能已经是子类了。在这种情况下，你可用组合来修补订阅逻辑，就像我们在这里做的一样。</span></span><br><span class="line">                   </span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Editor</span> is</span><br><span class="line">	<span class="keyword">public</span> field events: EventManager</span><br><span class="line">	<span class="keyword">private</span> field file:File</span><br><span class="line">	constructor <span class="title function_">Editor</span><span class="params">()</span> <span class="type">is</span></span><br><span class="line">  	<span class="variable">events</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">EventManager</span>()</span><br><span class="line">   </span><br><span class="line">  <span class="comment">// 业务逻辑的方法可将变化通知给订阅者。</span></span><br><span class="line">  method <span class="title function_">openFile</span><span class="params">(path)</span> is</span><br><span class="line">   	<span class="built_in">this</span>.file = <span class="keyword">new</span> <span class="title class_">File</span>(path)</span><br><span class="line">   	events.notify(<span class="string">&quot;open&quot;</span>, file.name)</span><br><span class="line">   	</span><br><span class="line">  method <span class="title function_">saveFile</span><span class="params">()</span> is</span><br><span class="line">  	file.write()</span><br><span class="line">  	events.notify(<span class="string">&quot;save&quot;</span>, file.name)</span><br><span class="line">  	</span><br><span class="line"><span class="comment">// 这里是订阅者接口。如果你的编程语言支持函数类型，则可用一组函数来代替整个订阅者的层次结构。</span></span><br><span class="line"><span class="keyword">interface</span> <span class="title class_">EventListener</span> is</span><br><span class="line">	method <span class="title function_">update</span><span class="params">(filename)</span></span><br><span class="line">	</span><br><span class="line">	</span><br><span class="line"><span class="comment">// 具体订阅者会对其注册的发布者所发出的更新消息做出响应。</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">LoggingListener</span> <span class="keyword">implements</span> <span class="title class_">EventListener</span> is</span><br><span class="line">	<span class="keyword">private</span> field log: File</span><br><span class="line">	<span class="keyword">private</span> field message: string</span><br><span class="line">	</span><br><span class="line">	constructor <span class="title function_">LoggingListener</span><span class="params">(log_filename, message)</span> is</span><br><span class="line">		<span class="built_in">this</span>. log = <span class="keyword">new</span> <span class="title class_">File</span>(log_filename)</span><br><span class="line">		<span class="built_in">this</span>.message = message</span><br><span class="line">		</span><br><span class="line">  method <span class="title function_">update</span><span class="params">(filename)</span> is</span><br><span class="line">  	log.write(replace(<span class="string">&#x27;%s&#x27;</span>,filename,message))</span><br><span class="line">  	</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">EmailAlertsListener</span> <span class="keyword">implements</span> <span class="title class_">EventListener</span> is</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> field email: string</span><br><span class="line">	<span class="keyword">private</span> field message: string</span><br><span class="line">	</span><br><span class="line">	constructor <span class="title function_">EmailAlertsListener</span><span class="params">(email, message)</span> is</span><br><span class="line">		<span class="built_in">this</span>.email = email</span><br><span class="line">		<span class="built_in">this</span>.message = message</span><br><span class="line">  </span><br><span class="line">  method <span class="title function_">update</span><span class="params">(filename)</span> is</span><br><span class="line">  	system.email(email, replace(<span class="string">&#x27;%s&#x27;</span>,filename,message))</span><br><span class="line">  	</span><br><span class="line">  	</span><br><span class="line"><span class="comment">// 应用程序可在运行时配置发布者和订阅者。</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Application</span> is</span><br><span class="line">	method <span class="title function_">config</span><span class="params">(）is</span></span><br><span class="line"><span class="params">		editor = new Editor()</span></span><br><span class="line">		logger = <span class="keyword">new</span> <span class="title class_">LoggingListener</span>(</span><br><span class="line">			<span class="string">&quot;/path/to/log.txt&quot;</span>,</span><br><span class="line">			“有人打开了文件：%s<span class="string">&quot;);</span></span><br><span class="line"><span class="string">    editor.events.subscribe(&quot;</span>open<span class="string">&quot;, logger)</span></span><br><span class="line"><span class="string">    </span></span><br><span class="line"><span class="string">    emailAlerts = new EmailAlertsListener(</span></span><br><span class="line"><span class="string">    	&quot;</span>admin<span class="meta">@example</span>.com<span class="string">&quot;&quot;</span>,</span><br><span class="line">    	“有人更改了文件：%s<span class="string">&quot;);</span></span><br><span class="line"><span class="string">    	</span></span><br><span class="line"><span class="string">    editor.events.subscribe(&quot;</span>save<span class="string">&quot;, emailAlerts)</span></span><br></pre></td></tr></table></figure>
<h3 id="应用场景-5"><a href="#应用场景-5" class="headerlink" title="应用场景"></a>应用场景</h3><ul>
<li><p><strong>当一个对象状态的改变需要改变其他对象，或实际对象是事先未知的或动态变化的时，可使用观察者模式</strong></p>
<p>当你使用图形用户界面类时通常会遇到一个问题。比如，你创建了自定义按钮类并允许客户端在按钮中注入自定义代码，这样当用户按下按钮时就会触发这些代码。  </p>
<p>观察者模式允许任何实现了订阅者接口的对象订阅发布者对象的事件通知。你可在按钮中添加订阅机制，允许客户端通过自定义订阅类注入自定义代码。  </p>
</li>
<li><p><strong>当应用中的一些对象必须观察其他对象时，可使用该模式。但仅能在有限时间内或特定情况下使用</strong></p>
<p>订阅列表是动态的，因此订阅者可随时加入或离开该列表。  </p>
</li>
</ul>
<h3 id="实现方式-5"><a href="#实现方式-5" class="headerlink" title="实现方式"></a>实现方式</h3><ol>
<li>仔细检查你的业务逻辑，试着将其拆分为两个部分：独立于其他代码的核心功能将作为发布者；其他代码则将转化为一组订阅类。</li>
<li>声明订阅者接口。该接口至少应声明一个 update 方法。</li>
<li>声明发布者接口并定义一些接口来在列表中添加和删除订阅对象。记住发布者必须仅通过订阅者接口与它们进行交互。</li>
<li>确定存放实际订阅列表的位置并实现订阅方法。通常所有类型的发布者代码看上去都一样，因此将列表放置在直接扩展自发布者接口的抽象类中是显而易见的。具体发布者会扩展该类从而继承所有的订阅行为。</li>
<li>创建具体发布者类。每次发布者发生了重要事件时都必须通知所有的订阅者。  </li>
<li>在具体订阅者类中实现通知更新的方法。绝大部分订阅者需要一些与事件相关的上下文数据。这些数据可作为通知方法的参数来传递。</li>
<li>客户端必须生成所需的全部订阅者，并在相应的发布者处完成注册工作。    </li>
</ol>
<h3 id="优缺点-5"><a href="#优缺点-5" class="headerlink" title="优缺点"></a>优缺点</h3><ul>
<li>开闭原则。 你无需修改发布者代码就能引入新的订阅者类（如果是发布者接口则可轻松引入发布者类）。</li>
<li>你可以在运行时建立对象之间的联系。</li>
</ul>
<hr>
<ul>
<li>订阅者的通知顺序是随机的。  </li>
</ul>
<h3 id="与其他模式的关系-5"><a href="#与其他模式的关系-5" class="headerlink" title="与其他模式的关系"></a>与其他模式的关系</h3><ul>
<li><p>责任链、命令、中介者和观察者用于处理请求发送者和接收者之间的不同连接方式：  </p>
<ul>
<li>责任链按照顺序将请求动态传递给一系列的潜在接收者，直至其中一名接收者对请求进行处理。</li>
<li>命令在发送者和请求者之间建立单向连接。  </li>
<li>中介者清除了发送者和请求者之间的直接连接，强制它们通过一个中介对象进行间接沟通。</li>
<li>观察者允许接收者动态地订阅或取消接收请求。</li>
</ul>
</li>
<li><p>中介者和观察者之间的区别往往很难记住。在大部分情况下，你可以使用其中一种模式，而有时可以同时使用。让我们来看看如何做到这一点。  </p>
<p>中介者的主要目标是消除一系列系统组件之间的相互依赖。这些组件将依赖于同一个中介者对象。观察者的目标是在对象之间建立动态的单向连接，使得部分对象可作为其他对象的附属发挥作用。</p>
<p>有一种流行的中介者模式实现方式依赖于观察者。中介者对象担当发布者的角色，其他组件则作为订阅者，可以订阅中介者的事件或取消订阅。当中介者以这种方式实现时，它可能看上去与观察者非常相似。</p>
<p>当你感到疑惑时，记住可以采用其他方式来实现中介者。例如，你可永久性地将所有组件链接到同一个中介者对象。这种实现方式和观察者并不相同，但这仍是一种中介者模式。</p>
<p>假设有一个程序，其所有的组件都变成了发布者，它们之间可以相互建立动态连接。这样程序中就没有中心化的中介者对象，而只有一些分布式的观察者。</p>
</li>
</ul>
<h2 id="状态"><a href="#状态" class="headerlink" title="状态"></a>状态</h2><blockquote>
<p>State</p>
</blockquote>
<p>状态是一种行为设计模式，让你能在一个对象的内部状态变化时改变其行为，使其看上去就像改变了自身所属的类一样。</p>
<h3 id="问题背景-6"><a href="#问题背景-6" class="headerlink" title="问题背景"></a>问题背景</h3><p><img src="/posts/23570/image-20240513101303209.png" alt="image-20240513101303209" style="zoom:33%;"></p>
<p>其主要思想是程序在任意时刻仅可处于几种有限的状态中。在任何一个特定状态中，程序的行为都不相同，且可瞬间从一个状态切换到另一个状态。不过，根据当前状态，程序可能会切换到另外一种状态，也可能会保持当前状态不变。这些数量有限且预先定义的状态切换规则被称为转移。</p>
<p>你还可将该方法应用在对象上。 假如你有一个 文档Document 类。 文档可能会处于 草稿 <code>Draft</code> 、 审阅中 <code>Moderation</code> 和 已发布 <code>Published</code> 三种状态中的一种。 文档的 publish 发布 方法在不同状态下的行为略有不同：  </p>
<ul>
<li>处于 草稿 状态时，它会将文档转移到审阅中状态</li>
<li>处于 审阅中 状态时，如果当前用户是管理员，它会公开发布文档。</li>
<li>处于 已发布 状态时，它不会进行任何操作。</li>
</ul>
<p><img src="/posts/23570/image-20240513102217206.png" alt="image-20240513102217206" style="zoom:33%;"></p>
<p>状态机通常由众多条件运算符（ if 或 switch ）实现，可根据对象的当前状态选择相应的行为。“状态”通常只是对象中的一组成员变量值。 即使你之前从未听说过有限状态机，你也很可能已经实现过状态模式。</p>
<p>当我们逐步在 文档 类中添加更多状态和依赖于状态的行为后，基于条件语句的状态机就会暴露其最大的弱点。为了能根据当前状态选择完成相应行为的方法，绝大部分方法中会包含复杂的条件语句。修改其转换逻辑可能会涉及到修改所有方法中的状态条件语句，导致代码的维护工作非常艰难。</p>
<p>这个问题会随着项目进行变得越发严重。我们很难在设计阶段预测到所有可能的状态和转换。随着时间推移，最初仅包含有限条件语句的简洁状态机可能会变成臃肿的一团乱麻。</p>
<h3 id="解决方案-6"><a href="#解决方案-6" class="headerlink" title="解决方案"></a>解决方案</h3><p>状态模式建议为对象的所有可能状态新建一个类，然后将所有状态的对应行为抽取到这些类中。  </p>
<p>原始对象被称为上下文（context），它并不会自行实现所有行为，而是会保存一个指向表示当前状态的状态对象的引用，且将所有与状态相关的工作委派给该对象。  </p>
<p><img src="/posts/23570/image-20240513103206910.png" alt="image-20240513103206910"></p>
<p>如需将上下文转换为另外一种状态，则需将当前活动的状态对象替换为另外一个代表新状态的对象。采用这种方式是有前提的：所有状态类都必须遵循同样的接口，而且上下文必须仅通过接口与这些对象进行交互。</p>
<p>这个结构可能看上去与策略模式相似，但有一个关键性的不同——在状态模式中， 特定状态知道其他所有状态的存在，且能触发从一个状态到另一个状态的转换；策略则几乎完全不知道其他策略的存在。 </p>
<h3 id="结构-6"><a href="#结构-6" class="headerlink" title="结构"></a>结构</h3><p><img src="/posts/23570/image-20240513105611909.png" alt="image-20240513105611909"></p>
<ol>
<li><p>上下文（<code>Context</code>）保存了对于一个具体状态对象的引用，并会将所有与该状态相关的工作委派给它。上下文通过状态接口与状态对象交互，且会提供一个设置器用于传递新的状态对象。</p>
</li>
<li><p>状态（<code>State</code>）接口会声明特定于状态的方法。这些方法应能被其他所有具体状态所理解，因为你不希望某些状态所拥有的方法永远不会被调用。</p>
</li>
<li><p>具体状态（<code>Concrete States</code>）会自行实现特定于状态的方法。为了避免多个状态中包含相似代码，你可以提供一个封装有部分通用行为的中间抽象类。</p>
<p>状态对象可存储对于上下文对象的反向引用。状态可以通过该引用从上下文处获取所需信息，并且能触发状态转移。  </p>
</li>
<li><p>上下文和具体状态都可以设置上下文的下个状态，并可通过替换连接到上下文的状态对象来完成实际的状态转换。</p>
</li>
</ol>
<h3 id="伪代码-6"><a href="#伪代码-6" class="headerlink" title="伪代码"></a>伪代码</h3><p>在本例中，状态模式将根据当前回放状态，让媒体播放器中的相同控件完成不同的行为。  </p>
<p><img src="/posts/23570/image-20240513121036352.png" alt="image-20240513121036352"></p>
<p>播放器的主要对象总是会连接到一个负责播放器绝大部分工作的状态对象中。 部分操作会更换播放器当前的状态对象，以此改变播放器对于用户互动所作出的反应。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//音频播放器（AudioPlayer）类即为上下文。它还会维护指向状态类实例的引用，该状态类则用于表示音频播放器当前的状态。</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">AudioPlayer</span> is</span><br><span class="line">  field state:State</span><br><span class="line">  field uI, volume, playlist, currentsong</span><br><span class="line">    </span><br><span class="line">  constructor <span class="title function_">AudioPlayer</span><span class="params">()</span> is</span><br><span class="line">    <span class="built_in">this</span>.state = <span class="keyword">new</span> <span class="title class_">ReadyState</span>(<span class="built_in">this</span>)</span><br><span class="line">    </span><br><span class="line">  <span class="comment">//上下文会将处理用户输入的工作委派给状态对象。由于每个状态都以不同的方式处理输入，其结果自然将依赖于当前所处的状态。</span></span><br><span class="line">    UI = <span class="keyword">new</span> <span class="title class_">UserInterface</span>()</span><br><span class="line">    UI.lockButton.onClick(<span class="built_in">this</span>.clickLock)</span><br><span class="line">    UI.nextButton.onClick(<span class="built_in">this</span>.clickNext)</span><br><span class="line">    UI.playButton.onClick(<span class="built_in">this</span>.clickPlay) </span><br><span class="line">    UI.prevButton.onClick(<span class="built_in">this</span>.clickPrevious)</span><br><span class="line">    </span><br><span class="line">  <span class="comment">//其他对象必须能切换音频播放器当前所处的状态。</span></span><br><span class="line">  method <span class="title function_">changeState</span><span class="params">(state: State)</span> is</span><br><span class="line">    <span class="built_in">this</span>.state = state</span><br><span class="line">    </span><br><span class="line">  <span class="comment">// UI方法会将执行工作委派给当前状态。</span></span><br><span class="line">  method <span class="title function_">clickLock</span><span class="params">()</span> is</span><br><span class="line">    state.clickLock()</span><br><span class="line">    </span><br><span class="line">  method <span class="title function_">clickPlay</span><span class="params">()</span> is</span><br><span class="line">    state.clickPlay()</span><br><span class="line">                   </span><br><span class="line"> 	method <span class="title function_">clickNext</span><span class="params">()</span> is</span><br><span class="line">    state.clickNext()</span><br><span class="line">    </span><br><span class="line">  method <span class="title function_">clickPrevious</span><span class="params">()</span> is</span><br><span class="line">    state.clickPrevious()</span><br><span class="line">    </span><br><span class="line">  <span class="comment">//状态可调用上下文的一些服务方法。</span></span><br><span class="line">  method <span class="title function_">startPlayback</span><span class="params">()</span> is</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">  method <span class="title function_">stopPlayback</span><span class="params">()</span> is</span><br><span class="line">  	<span class="comment">// ...</span></span><br><span class="line">  method <span class="title function_">nextSong</span><span class="params">()</span> is</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">  method <span class="title function_">previousSong</span><span class="params">()</span> is</span><br><span class="line">    <span class="comment">// ... </span></span><br><span class="line">  method <span class="title function_">fastForward</span><span class="params">(time)</span> is</span><br><span class="line">  	<span class="comment">// ...  </span></span><br><span class="line">  method <span class="title function_">rewind</span><span class="params">(time)</span> is</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    </span><br><span class="line"><span class="comment">//所有具体状态类都必须实现状态基类声明的方法，并提供反向引用指向与状态相关的上下文对象。状态可使用反向引用将上下文转换为另一个状态。</span></span><br><span class="line">abstractclass State is</span><br><span class="line">  <span class="keyword">protected</span> field player: AudioPlayer</span><br><span class="line">  <span class="comment">//上下文将自身传逆给状态构造函数。这可帮助状态在需要时获取一些有用的上下文数据。</span></span><br><span class="line">  constructor <span class="title function_">State</span><span class="params">(player)</span> is</span><br><span class="line">  	<span class="built_in">this</span>.player = player</span><br><span class="line">	<span class="keyword">abstract</span> method <span class="title function_">clickLock</span><span class="params">()</span></span><br><span class="line">  <span class="keyword">abstract</span> method <span class="title function_">clickPlay</span><span class="params">()</span></span><br><span class="line">  <span class="keyword">abstract</span> method <span class="title function_">clickNext</span><span class="params">()</span></span><br><span class="line">  <span class="keyword">abstract</span> method <span class="title function_">clickPrevious</span><span class="params">()</span></span><br><span class="line">    </span><br><span class="line"><span class="comment">//具体状态会实现与上下文状态相关的多种行为。</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">LockedState</span> <span class="keyword">extends</span> <span class="title class_">State</span> is</span><br><span class="line">      </span><br><span class="line">    <span class="comment">// 当你解锁一个锁定的播放器时，它可能处于两种状态之一。</span></span><br><span class="line">    method <span class="title function_">clickLock</span><span class="params">()</span> is</span><br><span class="line">      <span class="title function_">if</span> <span class="params">(player.playing)</span></span><br><span class="line">        player.changeState(<span class="keyword">new</span> <span class="title class_">PlayingState</span>(player))</span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">        player.changeState(<span class="keyword">new</span> <span class="title class_">ReadyState</span>(player))</span><br><span class="line">    method <span class="title function_">clickPlay</span><span class="params">()</span> is</span><br><span class="line">    	<span class="comment">// 已锁定，什么也不做。</span></span><br><span class="line">    method <span class="title function_">clickNext</span><span class="params">()</span> is</span><br><span class="line">      <span class="comment">// 已锁定，什么也不做。</span></span><br><span class="line">    method <span class="title function_">clickPrevious</span><span class="params">()</span> is</span><br><span class="line">      <span class="comment">// 已锁定，什么也不做。</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//它们还可在上下文中触发状态转换。</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ReadyState</span> <span class="keyword">extends</span> <span class="title class_">State</span> is</span><br><span class="line">  method <span class="title function_">clickLock</span><span class="params">()</span> is</span><br><span class="line">  	player.changeState(<span class="keyword">new</span> <span class="title class_">Lockedstate</span>(player))</span><br><span class="line">  </span><br><span class="line">  method <span class="title function_">clickPlay</span><span class="params">()</span> is</span><br><span class="line">  	player.startPlayback()</span><br><span class="line">  	player.changeState(<span class="keyword">new</span> <span class="title class_">Playingstate</span>(player))</span><br><span class="line">  </span><br><span class="line">  method <span class="title function_">clickNext</span><span class="params">()</span> is</span><br><span class="line">  	player.nextsong()</span><br><span class="line">  </span><br><span class="line">  method <span class="title function_">clickPrevious</span><span class="params">()</span> is</span><br><span class="line">  	player.previousSong()</span><br><span class="line">  </span><br><span class="line"><span class="keyword">class</span> <span class="title class_">PlayingState</span> <span class="keyword">extends</span> <span class="title class_">State</span> is</span><br><span class="line">  method <span class="title function_">clickLock</span><span class="params">()</span> is</span><br><span class="line">  	player.changeState(<span class="keyword">new</span> <span class="title class_">Lockedstate</span>(player))</span><br><span class="line">  </span><br><span class="line">  method <span class="title function_">clickPlay</span><span class="params">()</span> is</span><br><span class="line">  	player.stopPlayback()</span><br><span class="line">  	player.changeState(<span class="keyword">new</span> <span class="title class_">ReadyState</span>(player))</span><br><span class="line">  </span><br><span class="line">	method <span class="title function_">clickNext</span><span class="params">()</span> is</span><br><span class="line">    <span class="title function_">if</span> <span class="params">(event.doubleclick)</span></span><br><span class="line">      player.nextSong()</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">      player.fastForward(<span class="number">5</span>)</span><br><span class="line">      </span><br><span class="line">  method <span class="title function_">clickPrevious</span><span class="params">()</span> is</span><br><span class="line">    <span class="title function_">if</span> <span class="params">(event.doubleclick)</span></span><br><span class="line">      player.previous()</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">      player.rewind(<span class="number">5</span>)</span><br></pre></td></tr></table></figure>
<h3 id="应用场景-6"><a href="#应用场景-6" class="headerlink" title="应用场景"></a>应用场景</h3><ul>
<li><p><strong>如果对象需要根据自身当前状态进行不同行为，同时状态的数量非常多且与状态相关的代码会频繁变更的话，可使用状态模式。</strong></p>
<p>模式建议你将所有特定于状态的代码抽取到一组独立的类中。这样一来，你可以在独立于其他状态的情况下添加新状态或修改已有状态，从而减少维护成本。  </p>
</li>
<li><p><strong>如果某个类需要根据成员变量的当前值改变自身行为，从而需要使用大量的条件语句时，可使用该模式。</strong>  </p>
<p>状态模式会将这些条件语句的分支抽取到相应状态类的方法中。同时，你还可以清除主要类中与特定状态相关的临时成员变量和帮手方法代码。  </p>
</li>
<li><p><strong>当相似状态和基于条件的状态机转换中存在许多重复代码时，可使用状态模式。</strong></p>
<p>状态模式让你能够生成状态类层次结构，通过将公用代码抽取到抽象基类中来减少重复。  </p>
</li>
</ul>
<h4 id="实现方式-6"><a href="#实现方式-6" class="headerlink" title="实现方式"></a>实现方式</h4><ol>
<li><p>确定哪些类是上下文。它可能是包含依赖于状态的代码的已有类；如果特定于状态的代码分散在多个类中，那么它可能是一个新的类。</p>
</li>
<li><p>声明状态接口。虽然你可能会需要完全复制上下文中声明的所有方法，但最好是仅把关注点放在那些可能包含特定于状态的行为的方法上。</p>
</li>
<li><p>为每个实际状态创建一个继承于状态接口的类。然后检查上下文中的方法并将与特定状态相关的所有代码抽取到新建的类中。</p>
<p>在将代码移动到状态类的过程中，你可能会发现它依赖于上下文中的一些私有成员。你可以采用以下几种变通方式：  </p>
<ul>
<li>将这些成员变量或方法设为公有。</li>
<li>将需要抽取的上下文行为更改为上下文中的公有方法，然后在状态类中调用。这种方式简陋却便捷，你可以稍后再对其进行修补。</li>
<li>将状态类嵌套在上下文类中。这种方式需要你所使用的编程语言支持嵌套类。</li>
</ul>
</li>
<li><p>在上下文类中添加一个状态接口类型的引用成员变量，以及一个用于修改该成员变量值的公有设置器。</p>
</li>
<li><p>再次检查上下文中的方法，将空的条件语句替换为相应的状态对象方法。</p>
</li>
<li><p>为切换上下文状态，你需要创建某个状态类实例并将其传递给上下文。你可以在上下文、各种状态或客户端中完成这项工作。无论在何处完成这项工作，该类都将依赖于其所实例化的具体类。</p>
</li>
</ol>
<h4 id="优缺点-6"><a href="#优缺点-6" class="headerlink" title="优缺点"></a>优缺点</h4><ul>
<li>单一职责原则。将与特定状态相关的代码放在单独的类中。</li>
<li>开闭原则。无需修改已有状态类和上下文就能引入新状态。</li>
<li>通过消除臃肿的状态机条件语句简化上下文代码。</li>
</ul>
<hr>
<ul>
<li>如果状态机只有很少的几个状态，或者很少发生改变，那么应用该模式可能会显得小题大作。</li>
</ul>
<h3 id="与其他模式的关系-6"><a href="#与其他模式的关系-6" class="headerlink" title="与其他模式的关系"></a>与其他模式的关系</h3><ul>
<li>桥接、状态和策略（在某种程度上包括适配器）模式的接口非常相似。实际上，它们都基于组合模式——即将工作委派给其他对象，不过也各自解决了不同的问题。模式并不只是以特定方式组织代码的配方，你还可以使用它们来和其他开发者讨论模式所解决的问题。</li>
<li>状态可被视为策略的扩展。两者都基于组合机制：它们都通过将部分工作委派给“帮手”对象来改变其在不同情景下的行为。策略使得这些对象相互之间完全独立，它们不知道其他对象的存在。 但状态模式没有限制具体状态之间的依赖，且允许它们自行改变在不同情景下的状态。</li>
</ul>
<h3 id="策略"><a href="#策略" class="headerlink" title="策略"></a>策略</h3><blockquote>
<p>Strategy</p>
</blockquote>
<p>策略是一种行为设计模式，它能让你定义一系列算法，并将每种算法分别放入独立的类中，以使算法的对象能够相互替换。</p>
<h3 id="问题背景-7"><a href="#问题背景-7" class="headerlink" title="问题背景"></a>问题背景</h3><p>一天，你打算为游客们创建一款导游程序。该程序的核心功能是提供美观的地图，以帮助用户在任何城市中快速定位。</p>
<p>用户期待的程序新功能是自动路线规划：他们希望输入地址后就能在地图上看到前往目的地的最快路线。</p>
<p>程序的首个版本只能规划公路路线。驾车旅行的人们对此非常满意。但很显然，并非所有人都会在度假时开车。因此你在下次更新时添加了规划步行路线的功能。此后，你又添加了规划公共交通路线的功能。</p>
<p>而这只是个开始。不久后，你又要为骑行者规划路线。又过了一段时间，你又要为游览城市中的所有景点规划路线。</p>
<p>尽管从商业角度来看，这款应用非常成功，但其技术部分却让你非常头疼：每次添加新的路线规划算法后，导游应用中主要类的体积就会增加一倍。终于在某个时候，你觉得自己没法继续维护这堆代码了</p>
<p>无论是修复简单缺陷还是微调街道权重，对某个算法进行任何修改都会影响整个类，从而增加在已有正常运行代码中引入错误的风险。</p>
<p>此外，团队合作将变得低效。如果你在应用成功发布后招募了团队成员，他们会抱怨在合并冲突的工作上花费了太多时间。在实现新功能的过程中，你的团队需要修改同一个巨大的类，这样他们所编写的代码相互之间就可能会出现冲突。</p>
<h3 id="解决方案-7"><a href="#解决方案-7" class="headerlink" title="解决方案"></a>解决方案</h3><p>策略模式建议找出负责用许多不同方式完成特定任务的类，然后将其中的算法抽取到一组被称为策略的独立类中。</p>
<p>名为上下文的原始类必须包含一个成员变量来存储对于每种策略的引用。上下文并不执行任务，而是将工作委派给已连接的策略对象。</p>
<p>上下文不负责选择符合任务需要的算法——客户端会将所需策略传递给上下文。实际上，上下文并不十分了解策略，它会通过同样的通用接口与所有策略进行交互，而该接口只需暴露一个方法来触发所选策略中封装的算法即可。</p>
<p>因此，上下文可独立于具体策略。这样你就可在不修改上下文代码或其他策略的情况下添加新算法或修改已有算法了。</p>
<p><img src="/posts/23570/image-20240513132839728.png" alt="image-20240513132839728"></p>
<p>在导游应用中， 每个路线规划算法都可被抽取到只有一个buildRoute 生成路线 方法的独立类中。该方法接收起点和终点作为参数，并返回路线中途点的集合。</p>
<p>即使传递给每个路径规划类的参数一模一样，其所创建的路线也可能完全不同。主要导游类的主要工作是在地图上渲染一系列中途点，不会在意如何选择算法。该类中还有一个用于切换当前路径规划策略的方法，因此客户端（例如用户界面中的按钮）可用其他策略替换当前选择的路径规划行为。</p>
<h3 id="结构-7"><a href="#结构-7" class="headerlink" title="结构"></a>结构</h3><p><img src="/posts/23570/image-20240513133242266.png" alt="image-20240513133242266"></p>
<ol>
<li>上下文（<code>Context</code>）维护指向具体策略的引用，且仅通过策略<br>接口与该对象进行交流。</li>
<li>策略（<code>Strategy</code>）接口是所有具体策略的通用接口，它声明<br>了一个上下文用于执行策略的方法。</li>
<li>具体策略（<code>Concrete Strategies</code>）实现了上下文所用算法的各<br>种不同变体。</li>
<li>当上下文需要运行算法时，它会在其已连接的策略对象上调<br>用执行方法。上下文不清楚其所涉及的策略类型与算法的执<br>行方式。</li>
<li>客户端（<code>Client</code>）会创建一个特定策略对象并将其传递给上<br>下文。上下文则会提供一个设置器以便客户端在运行时替换<br>相关联的策略</li>
</ol>
<h3 id="伪代码-7"><a href="#伪代码-7" class="headerlink" title="伪代码"></a>伪代码</h3><p>在本例中，上下文使用了多个策略来执行不同的计算操作。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 策略接口声明了某个算法各个不同版本间所共有的操作。上下文会使用该接口来调用有具体策略定义的算法。</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">interface</span> <span class="title class_">Strategy</span> is</span><br><span class="line">	method <span class="title function_">execute</span><span class="params">(a, b)</span></span><br><span class="line">	</span><br><span class="line"><span class="comment">// 具体策略会在遵循策略基础接口的情况下实现算法。该接口实现了它们在上下文中的互换性。</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ConcreteStrategyAdd</span> <span class="keyword">implements</span> <span class="title class_">Strategy</span> is</span><br><span class="line">	method <span class="title function_">execute</span><span class="params">(a, b)</span> is</span><br><span class="line">		<span class="keyword">return</span> a+b</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ConcreteStrategySubtract</span> <span class="keyword">implements</span> <span class="title class_">Strategy</span> is</span><br><span class="line">	method <span class="title function_">execute</span><span class="params">(a, b)</span> is</span><br><span class="line">		<span class="keyword">return</span> a-b</span><br><span class="line">		</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ConcreteStrategyMultiply</span> <span class="keyword">implements</span> <span class="title class_">Strategy</span> is</span><br><span class="line">	method <span class="title function_">execute</span><span class="params">(a, b)</span> is</span><br><span class="line">		<span class="keyword">return</span> a*b</span><br><span class="line">		</span><br><span class="line"><span class="comment">//上下文定义了客户端关注的接口。</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Context</span> is</span><br><span class="line"><span class="comment">//上下文会维护指向某个策略对象的引用。上下文不知晓策略的具体类。上下文必须通过策略接口来与所有策略进行交互。</span></span><br><span class="line">	<span class="keyword">private</span> strategy: Strategy</span><br><span class="line">	</span><br><span class="line">	<span class="comment">// 上下文通常会通过构造函数来接收策略对象，同时还提供设置器以便在运行时切换策略。</span></span><br><span class="line">	method <span class="title function_">setstrategy</span><span class="params">(Strategy strategy)</span> is</span><br><span class="line">		<span class="built_in">this</span>.strategy = strategy</span><br><span class="line">		</span><br><span class="line">  <span class="comment">//上下文会将一些工作委派给策略对象，而不是自行实现不同版本的算法。</span></span><br><span class="line">  method <span class="title function_">executeStrategy</span><span class="params">(<span class="type">int</span> a，<span class="type">int</span> b）is</span></span><br><span class="line"><span class="params">  	return strategy.execute(a, b)</span></span><br><span class="line">  	</span><br><span class="line"><span class="comment">//客户端代码会选择具体策略并将其传递给上下文。客户端必须知晓策略之间的差异，才能做出正确的选择。</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ExampleApplication</span> is</span><br><span class="line">	method <span class="title function_">main</span><span class="params">()</span> is</span><br><span class="line">    <span class="comment">// 创建上下文对象。</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 读取第一个数。</span></span><br><span class="line">    <span class="comment">// 读取最后一个数。</span></span><br><span class="line">    <span class="comment">// 从用户输入中读取期望进行的行为。</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (action == addition) then</span><br><span class="line">      context.setstrategy(<span class="keyword">new</span> <span class="title class_">ConcreteStrategyAdd</span>())</span><br><span class="line">    <span class="keyword">if</span> (action == subtraction) then</span><br><span class="line">    	context.setstrategy(<span class="keyword">new</span> <span class="title class_">oncretestrategySubtract</span>())</span><br><span class="line">    <span class="keyword">if</span> (action == multiplication) then</span><br><span class="line">    	context.setStrategy(<span class="keyword">new</span> <span class="title class_">ConcreteStrategyMultiply</span>())</span><br><span class="line">    </span><br><span class="line">    result = context.executeStrategy(First number, Second number)</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 打印结果。</span></span><br></pre></td></tr></table></figure>
<h3 id="应用场景-7"><a href="#应用场景-7" class="headerlink" title="应用场景"></a>应用场景</h3><ul>
<li><p><strong>当你想使用对象中各种不同的算法变体，并希望能在运行时切换算法时，可使用策略模式。</strong></p>
<p>策略模式让你能够将对象关联至可以不同方式执行特定子任务的不同子对象，从而以间接方式在运行时更改对象行为。</p>
</li>
<li><p><strong>当你有许多仅在执行某些行为时略有不同的相似类时，可使用策略模式。</strong></p>
<p>策略模式让你能将不同行为抽取到一个独立类层次结构中，并将原始类组合成同一个，从而减少重复代码。</p>
</li>
<li><p><strong>如果算法在上下文的逻辑中不是特别重要，使用该模式能将类的业务逻辑与其算法实现细节隔离开来。</strong></p>
<p>策略模式让你能将各种算法的代码、内部数据和依赖关系与其他代码隔离开来。不同客户端可通过一个简单接口执行算法，并能在运行时进行切换。</p>
</li>
<li><p><strong>当类中使用了复杂条件运算符以在同一算法的不同变体中切换时，可使用该模式。</strong></p>
<p>策略模式将所有继承自同样接口的算法抽取到独立类中，因此不再需要条件语句。 原始对象并不实现所有算法的变体，而是将执行工作委派给其中的一个独立算法对象。  </p>
</li>
</ul>
<h3 id="实现方式-7"><a href="#实现方式-7" class="headerlink" title="实现方式"></a>实现方式</h3><ol>
<li>从上下文类中找出修改频率较高的算法（也可能是用于在运行时选择某个算法变体的复杂条件运算符）。</li>
<li>声明该算法所有变体的通用策略接口。  </li>
<li>将算法逐一抽取到各自的类中，它们都必须实现策略接口。  </li>
<li>在上下文类中添加一个成员变量用于保存对于策略对象的引用。然后提供设置器以修改该成员变量。上下文仅可通过策略接口同策略对象进行交互，如有需要还可定义一个接口来让策略访问其数据。</li>
<li>客户端必须将上下文类与相应策略进行关联，使上下文可以预期的方式完成其主要工作。  </li>
</ol>
<h3 id="优缺点-7"><a href="#优缺点-7" class="headerlink" title="优缺点"></a>优缺点</h3><ul>
<li>你可以在运行时切换对象内的算法。</li>
<li>你可以将算法的实现和使用算法的代码隔离开来。</li>
<li>你可以使用组合来代替继承。</li>
<li>开闭原则。你无需对上下文进行修改就能够引入新的策略。</li>
</ul>
<hr>
<ul>
<li>如果你的算法极少发生改变，没有任何理由引入新的类和接口，那么使用该模式只会让程序过于复杂。</li>
<li>客户端必须知晓策略间的不同——它需要选择合适的策略。</li>
<li>许多现代编程语言支持函数类型功能，允许你在一组匿名函数中实现不同版本的算法。这样，你使用这些函数的方式就和使用策略对象时完全相同，无需借助额外的类和接口来保持代码简洁。</li>
</ul>
<h3 id="与其他模式的关系-7"><a href="#与其他模式的关系-7" class="headerlink" title="与其他模式的关系"></a>与其他模式的关系</h3><ul>
<li>桥接、状态和策略（在某种程度上包括适配器）模式的接口非常相似。实际上，它们都基于组合模式——即将工作委派给其他对象，不过也各自解决了不同的问题。模式并不只是以特定方式组织代码的配方，你还可以使用它们来和其他开发者讨论模式所解决的问题。</li>
<li>命令和策略看上去很像，因为两者都能通过某些行为来参数化对象。但是，它们的意图有非常大的不同。<ul>
<li>你可以使用命令来将任何操作转换为对象。操作的参数将成为对象的成员变量。 你可以通过转换来延迟操作的执行、将操作放入队列、保存历史命令或者向远程服务发送命令等。</li>
<li>另一方面，策略通常可用于描述完成某件事的不同方式，让你能够在同一个上下文类中切换算法。</li>
</ul>
</li>
<li>装饰可让你更改对象的外表，策略则让你能够改变其本质。</li>
<li>模板方法基于继承机制：它允许你通过扩展子类中的部分内容来改变部分算法。策略基于组合机制：你可以通过对相应行为提供不同的策略来改变对象的部分行为。模板方法在类层次上运作，因此它是静态的。策略在对象层次上运作，因此允许在运行时切换行为。</li>
<li>状态可被视为策略的扩展。两者都基于组合机制：它们都通过将部分工作委派给“帮手”对象来改变其在不同情景下的行为。策略使得这些对象相互之间完全独立，它们不知道其他对象的存在。 但状态模式没有限制具体状态之间的依赖，且允许它们自行改变在不同情景下的状态。</li>
</ul>
<h2 id="模板方法"><a href="#模板方法" class="headerlink" title="模板方法"></a>模板方法</h2><blockquote>
<p>Template Method</p>
</blockquote>
<p>模板方法是一种行为设计模式，它在超类中定义了一个算法的框架，允许子类在不修改结构　　的情况下重写算法的特定步骤。</p>
<h3 id="问题背景-8"><a href="#问题背景-8" class="headerlink" title="问题背景"></a>问题背景</h3><p>假如你正在开发一款分析公司文档的数据挖掘程序。用户需要向程序输入各种格式（PDF、DOC 或 CSV）的文档，程序则会试图从这些文件中抽取有意义的数据，并以统一的格式将其返回给用户。</p>
<p>该程序的首个版本仅支持 DOC 文件。 在接下来的一个版本中，程序能够支持 CSV 文件。一个月后，你“教会”了程序从 PDF 文件中抽取数据。  </p>
<p><img src="/posts/23570/image-20240513140306271.png" alt="image-20240513140306271" style="zoom:33%;"></p>
<p>一段时间后，你发现这三个类中包含许多相似代码。尽管这些类处理不同数据格式的代码完全不同，但数据处理和分析的代码却几乎完全一样。如果能在保持算法结构完整的情况下去除重复代码，这难道不是一件很棒的事情吗？</p>
<p>还有另一个与使用这些类的客户端代码相关的问题：客户端代码中包含许多条件语句，以根据不同的处理对象类型选择合适的处理过程。如果所有处理数据的类都拥有相同的接口或基类，那么你就可以去除客户端代码中的条件语句，转而使用多态机制来在处理对象上调用函数。</p>
<h3 id="解决方案-8"><a href="#解决方案-8" class="headerlink" title="解决方案"></a>解决方案</h3><p>模板方法模式建议将算法分解为一系列步骤，然后将这些步骤改写为方法， 最后在“模板方法”中依次调用这些方法。步骤可以是 抽象 的，也可以有一些默认的实现。为了能够使用算法，客户端需要自行提供子类并实现所有的抽象步骤。如有必要还需重写一些步骤（但这一步中不包括模板方法自身）。</p>
<p>让我们考虑如何在数据挖掘应用中实现上述方案。我们可为图中的三个解析算法创建一个基类，该类将定义调用了一系列不同文档处理步骤的模板方法。</p>
<p><img src="/posts/23570/image-20240513140526165.png" alt="image-20240513140526165" style="zoom:33%;"></p>
<p>首先，我们将所有步骤声明为 抽象 类型，强制要求子类自行实现这些方法。在我们的例子中，子类中已有所有必要的实现，因此我们只需调整这些方法的签名，使之与超类的方法匹配即可。  </p>
<p>现在，让我们看看如何去除重复代码。对于不同的数据格式，打开和关闭文件以及抽取和解析数据的代码都不同，因此无需修改这些方法。但分析原始数据和生成报告等其他步骤的实现方式非常相似，因此可将其提取到基类中，以让子类共享这些代码。  </p>
<p>正如你所看到的那样，我们有两种类型的步骤：  </p>
<ul>
<li>抽象步骤必须由各个子类来实现</li>
<li>可选步骤已有一些默认实现，但仍可在需要时进行重写</li>
</ul>
<p>还有另一种名为钩子的步骤。 <strong>钩子是内容为空的可选步骤。</strong>即使不重写钩子，模板方法也能工作。<strong>钩子通常放置在算法重要步骤的前后，为子类提供额外的算法扩展点。</strong>  </p>
<h3 id="结构-8"><a href="#结构-8" class="headerlink" title="结构"></a>结构</h3><p><img src="/posts/23570/image-20240513140821788.png" alt="image-20240513140821788" style="zoom:33%;"></p>
<ol>
<li>抽象类（AbstractClass） 会声明作为算法步骤的方法， 以及依次调用它们的实际模板方法。 算法步骤可以被声明为抽象 类型，也可以提供一些默认实现。</li>
<li>具体类（ConcreteClass）可以重写所有步骤，但不能重写模板方法自身。</li>
</ol>
<h3 id="伪代码-8"><a href="#伪代码-8" class="headerlink" title="伪代码"></a>伪代码</h3><p>本例中的模板方法模式为一款简单策略游戏中人工智能的不同分支提供“框架”  </p>
<p><img src="/posts/23570/image-20240513140912818.png" alt="image-20240513140912818" style="zoom:33%;"></p>
<p>游戏中所有的种族都有几乎同类的单位和建筑。因此你可以在不同的种族上复用相同的 AI 结构，同时还需要具备重写一些细节的能力。通过这种方式，你可以重写半兽人的 AI 使其更富攻击性，也可以让人类侧重防守，还可以禁止怪物建造建筑。在游戏中新增种族需要创建新的 AI 子类，还需要重写AI 基类中所声明的默认方法  </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//抽象类定义了一个模板方法，其中通常会包含某个由抽象原语操作调用组成的算法框架。具体子类会实现这些操作，但是不会对模板方法做出修改。</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">GameAI</span> is</span><br><span class="line">	<span class="comment">//模板方法定义了某个算法的框架。</span></span><br><span class="line">	method <span class="title function_">turn</span><span class="params">()</span> is</span><br><span class="line">		<span class="title function_">collectResources</span><span class="params">()</span></span><br><span class="line">		buildstructures()</span><br><span class="line">		buildUnits()</span><br><span class="line">		attack()</span><br><span class="line">		</span><br><span class="line">  <span class="comment">//某些步骤可在基类中直接实现。</span></span><br><span class="line">  method <span class="title function_">collectResources</span><span class="params">()</span> is</span><br><span class="line">  	<span class="title function_">foreach</span> <span class="params">(s in <span class="built_in">this</span>.builtstructures)</span> <span class="keyword">do</span></span><br><span class="line">  		s.collect()</span><br><span class="line">  <span class="comment">//某些可定义为抽象类型。</span></span><br><span class="line">  <span class="keyword">abstract</span> method <span class="title function_">buildstructures</span><span class="params">()</span></span><br><span class="line">  <span class="keyword">abstract</span> method <span class="title function_">buildUnits</span><span class="params">()</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment">//一个类可包含多个模板方法。</span></span><br><span class="line">  method <span class="title function_">attack</span><span class="params">()</span> <span class="type">is</span></span><br><span class="line">  	<span class="variable">enemy</span> <span class="operator">=</span> closestEnemy()</span><br><span class="line">  	<span class="keyword">if</span> (enemy == <span class="literal">null</span>)</span><br><span class="line">  		sendScouts(map.center)</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    	sendwarriors(enemy.position)</span><br><span class="line">    	</span><br><span class="line">  <span class="keyword">abstract</span> method <span class="title function_">sendscouts</span><span class="params">(position)</span></span><br><span class="line">  <span class="keyword">abstract</span> method <span class="title function_">sendwarriors</span><span class="params">(position)</span></span><br><span class="line">  </span><br><span class="line"><span class="comment">//具体类必须实现基类中的所有抽象操作，但是它们不能重写模板方法自身。</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">OrcsAI</span> <span class="keyword">extends</span> <span class="title class_">GameAI</span> is</span><br><span class="line">	method <span class="title function_">buildstructures</span><span class="params">()</span> is</span><br><span class="line">		<span class="title function_">if</span> <span class="params">(there are some resources)</span> then</span><br><span class="line">			<span class="comment">//建造农场，接着是谷仓，然后是要塞。</span></span><br><span class="line">			</span><br><span class="line">    method <span class="title function_">buildunits</span><span class="params">()</span> is</span><br><span class="line">    	<span class="title function_">if</span> <span class="params">(there are plenty of resources)</span> then</span><br><span class="line">    		<span class="title function_">if</span> <span class="params">(there are no scouts)</span></span><br><span class="line">    			<span class="comment">// 建造苦工，将其加入侦查编组。</span></span><br><span class="line">        <span class="keyword">else</span> </span><br><span class="line">          <span class="comment">// 建造兽族步兵，将其加入战士编组。</span></span><br><span class="line"></span><br><span class="line">		method <span class="title function_">sendScouts</span><span class="params">(position)</span> is</span><br><span class="line">			<span class="title function_">if</span> <span class="params">(scouts.length &gt; <span class="number">0</span>)</span> then</span><br><span class="line">				<span class="comment">//将侦查编组送到指定位置。</span></span><br><span class="line">				</span><br><span class="line">    method <span class="title function_">sendwarriors</span><span class="params">(position)</span> is</span><br><span class="line">    	<span class="title function_">if</span> <span class="params">(warriors.length&gt; <span class="number">5</span>)</span> then</span><br><span class="line">    		将战斗编组送到指定位置。</span><br><span class="line">    		</span><br><span class="line"><span class="comment">// 子类可以重写部分默认的操作。</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">MonstersAI</span> <span class="keyword">extends</span> <span class="title class_">GameAI</span> is</span><br><span class="line">	method <span class="title function_">collectResources</span><span class="params">()</span> is</span><br><span class="line">		怪物不会采集资源。</span><br><span class="line">  method <span class="title function_">buildstructures</span><span class="params">()</span> is</span><br><span class="line">  	怪物不会建造建筑。</span><br><span class="line">  method <span class="title function_">buildUnits</span><span class="params">()</span> is</span><br><span class="line">  	怪物不会建造单位。</span><br></pre></td></tr></table></figure>
<h3 id="应用场景-8"><a href="#应用场景-8" class="headerlink" title="应用场景"></a>应用场景</h3><ul>
<li><p>当你只希望客户端扩展某个特定算法步骤，而不是整个算法或其结构时，可使用模板方法模式。  </p>
<p>模板方法将整个算法转换为一系列独立的步骤，以便子类能对其进行扩展，同时还可让超类中所定义的结构保持完整。 </p>
</li>
<li><p>当多个类的算法除一些细微不同之外几乎完全一样时，你可使用该模式。但其后果就是，只要算法发生变化，你就可能需要修改所有的类。</p>
<p>在将算法转换为模板方法时，你可将相似的实现步骤提取到超类中以去除重复代码。子类间各不同的代码可继续保留在子类中。  </p>
</li>
</ul>
<h3 id="实现方式-8"><a href="#实现方式-8" class="headerlink" title="实现方式"></a>实现方式</h3><ol>
<li>分析目标算法，确定能否将其分解为多个步骤。从所有子类的角度出发，考虑哪些步骤能够通用，哪些步骤各不相同。</li>
<li>创建抽象基类并声明一个模板方法和代表算法步骤的一系列抽象方法。 在模板方法中根据算法结构依次调用相应步骤。可用 final 最终修饰模板方法以防止子类对其进行重写。  </li>
<li>虽然可将所有步骤全都设为抽象类型，但默认实现可能会给部分步骤带来好处，因为子类无需实现那些方法。</li>
<li>可考虑在算法的关键步骤之间添加钩子。</li>
<li>为每个算法变体新建一个具体子类，它必须实现所有的抽象步骤，也可以重写部分可选步骤。</li>
</ol>
<h3 id="优缺点-8"><a href="#优缺点-8" class="headerlink" title="优缺点"></a>优缺点</h3><ul>
<li>你可仅允许客户端重写一个大型算法中的特定部分，使得算法其他部分修改对其所造成的影响减小。</li>
<li>你可将重复代码提取到一个超类中。</li>
</ul>
<hr>
<ul>
<li>部分客户端可能会受到算法框架的限制</li>
<li>通过子类抑制默认步骤实现可能会导致违反里氏替换原则 </li>
<li>模板方法中的步骤越多，其维护工作就可能会越困难</li>
</ul>
<h3 id="与其他模式的关系-8"><a href="#与其他模式的关系-8" class="headerlink" title="与其他模式的关系"></a>与其他模式的关系</h3><ul>
<li>工厂方法是模板方法的一种特殊形式。同时，工厂方法可以作为一个大型模板方法中的一个步骤。</li>
<li>模板方法基于继承机制：它允许你通过扩展子类中的部分内容来改变部分算法。策略基于组合机制：你可以通过对相应行为提供不同的策略来改变对象的部分行为。模板方法在类层次上运作，因此它是静态的。策略在对象层次上运作，因此允许在运行时切换行为。</li>
</ul>
<h2 id="访问者"><a href="#访问者" class="headerlink" title="访问者"></a>访问者</h2><blockquote>
<p>Visitor</p>
</blockquote>
<p>访问者是一种行为设计模式，它能将算法与其所作用的对象隔离开来。</p>
<h3 id="问题背景-9"><a href="#问题背景-9" class="headerlink" title="问题背景"></a>问题背景</h3><p>假如你的团队开发了一款能够使用巨型图像中地理信息的应用程序。图像中的每个节点既能代表复杂实体（例如一座城市）， 也能代表更精细的对象（例如工业区和旅游景点等）。如果节点代表的真实对象之间存在公路，那么这些节点就会相互连接。在程序内部，每个节点的类型都由其所属的类来表示，每个特定的节点则是一个对象。</p>
<p>一段时间后， 你接到了实现将图像导出到 XML 文件中的任务。这些工作最初看上去非常简单。你计划为每个节点类添加导出函数，然后递归执行图像中每个节点的导出函数。解决方案简单且优雅：使用多态机制可以让导出方法的调用代码不会和具体的节点类相耦合。  </p>
<p>但你不太走运，系统架构师拒绝批准对已有节点类进行修改。他认为这些代码已经是产品了，不想冒险对其进行修改，因为修改可能会引入潜在的缺陷。</p>
<p><img src="/posts/23570/image-20240513185628986.png" alt="image-20240513185628986"></p>
<p>此外，他还质疑在节点类中包含导出 XML 文件的代码是否有意义。这些类的主要工作是处理地理数据。导出 XML 文件的代码放在这里并不合适。</p>
<p>还有另一个原因，那就是在此项任务完成后，营销部门很有可能会要求程序提供导出其他类型文件的功能，或者提出其他奇怪的要求。这样你很可能会被迫再次修改这些重要但脆弱的类</p>
<h3 id="解决方案-9"><a href="#解决方案-9" class="headerlink" title="解决方案"></a>解决方案</h3><p>访问者模式建议将新行为放入一个名为访问者的独立类中，而不是试图将其整合到已有类中。现在，需要执行操作的原始对象将作为参数被传递给访问者中的方法，让方法能访问对象所包含的一切必要数据。</p>
<p>如果现在该操作能在不同类的对象上执行会怎么样呢？比如在我们的示例中，各节点类导出 XML 文件的实际实现很可能会稍有不同。因此，访问者类可以定义一组（而不是一个）方法，且每个方法可接收不同类型的参数，如下所示：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">IExportVisitor</span> <span class="keyword">implements</span> <span class="title class_">Visitor</span> is</span><br><span class="line">	method <span class="title function_">doForCity</span><span class="params">(City c)</span>&#123;...&#125;</span><br><span class="line">	method <span class="title function_">doForIndustry</span><span class="params">(Industry f)</span>&#123;...&#125;</span><br><span class="line">	method <span class="title function_">doForSightSeeing</span><span class="params">(SightSeeing ss）&#123;...&#125;</span></span><br><span class="line"><span class="params">	// ...</span></span><br></pre></td></tr></table></figure>
<p>但我们究竟应该如何调用这些方法（尤其是在处理整个图像方面）呢？这些方法的签名各不相同，因此我们不能使用多态机制。 为了可以挑选出能够处理特定对象的访问者方法，我们需要对它的类进行检查。这是不是听上去像个噩梦呢？</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">foreach (Node node in graph)</span><br><span class="line">	<span class="keyword">if</span> (node <span class="keyword">instanceof</span> City)</span><br><span class="line">		exportVisitor.doForcity((city) node)</span><br><span class="line">  <span class="keyword">if</span> (node <span class="keyword">instanceof</span> Industry)</span><br><span class="line">  	exportVisitor.doForIndustry((Industry) node)</span><br><span class="line">  <span class="comment">// ...</span></span><br></pre></td></tr></table></figure>
<p>你可能会问，我们为什么不使用方法重载呢？就是使用相同的方法名称，但它们的参数不同。不幸的是，即使我们的编程语言（例如 Java 和 C#）支持重载也不行。由于我们无法提前知晓节点对象所属的类，所以重载机制无法执行正确的方法。方法会将 节点 基类作为输入参数的默认类型。  </p>
<p>但是，访问者模式可以解决这个问题。它使用了一种名为双分派的技巧，不使用累赘的条件语句也可执行正确的方法。与其让客户端来选择调用正确版本的方法，不如将选择权委派给作为参数传递给访问者的对象。由于该对象知晓其自身的类，因此能更自然地在访问者中选出正确的方法。它们会“接收”一个访问者并告诉其应执行的访问者方法。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 客户端代码</span></span><br><span class="line">foreach(Node node in graph)</span><br><span class="line">  node.accept(exportVisitor)</span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line"><span class="comment">// 城市</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">City</span> is</span><br><span class="line">  method <span class="title function_">accept</span><span class="params">(Visitor v)</span> is</span><br><span class="line">  	V.doForCity(<span class="built_in">this</span>)</span><br><span class="line">  <span class="comment">//...</span></span><br><span class="line">  </span><br><span class="line"><span class="comment">// 工业区</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Industry</span> is</span><br><span class="line">  method <span class="title function_">accept</span><span class="params">(Visitor v)</span> is</span><br><span class="line">  	V.doForIndustry(<span class="built_in">this</span>)</span><br><span class="line">  <span class="comment">//...</span></span><br></pre></td></tr></table></figure>
<p>我承认最终还是修改了节点类，但毕竟改动很小，且使得我们能够在后续进一步添加行为时无需再次修改代码</p>
<p>现在，如果我们抽取出所有访问者的通用接口，所有已有的节点都能与我们在程序中引入的任何访问者交互。如果需要引入与节点相关的某个行为，你只需要实现一个新的访问者类即可。</p>
<h3 id="结构-9"><a href="#结构-9" class="headerlink" title="结构"></a>结构</h3><p><img src="/posts/23570/image-20240513190647685.png" alt="image-20240513190647685" style="zoom:33%;"></p>
<ol>
<li>访问者（Visitor）接口声明了一系列以对象结构的具体元素为参数的访问者方法。如果编程语言支持重载，这些方法的名称可以是相同的，但是其参数一定是不同的。</li>
<li>具体访问者（Concrete Visitor）会为不同的具体元素类实现相同行为的几个不同版本。</li>
<li>元素（Element） 接口声明了一个方法来“接收” 访问者。该方法必须有一个参数被声明为访问者接口类型。</li>
<li>具体元素（Concrete Element）必须实现接收方法。 该方法的目的是根据当前元素类将其调用重定向到相应访问者的方法。请注意，即使元素基类实现了该方法，所有子类都必须对其进行重写并调用访问者对象中的合适方法。  </li>
<li>客户端（Client）通常会作为集合或其他复杂对象（例如一个组合树）的代表。 客户端通常不知晓所有的具体元素类，因为它们会通过抽象接口与集合中的对象进行交互。</li>
</ol>
<h3 id="伪代码-9"><a href="#伪代码-9" class="headerlink" title="伪代码"></a>伪代码</h3><p>在本例中，访问者模式为几何图像层次结构添加了对于 XML文件导出功能的支持。  </p>
<p><img src="/posts/23570/image-20240513190955375.png" alt="image-20240513190955375" style="zoom:33%;"></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//元素接口声明了一个accept（接收）方法，它会将访问者基础接口作为一个参数。</span></span><br><span class="line"><span class="keyword">interface</span> <span class="title class_">Shape</span> is</span><br><span class="line">	method <span class="title function_">move</span><span class="params">(x, y)</span></span><br><span class="line">	method <span class="title function_">draw</span><span class="params">()</span></span><br><span class="line">	method <span class="title function_">accept</span><span class="params">(v: Visitor)</span></span><br><span class="line">	</span><br><span class="line"><span class="comment">//每个具体元素类都必须以特定方式实现方法，使其能调用相应元素类的T访问者方法。</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Dot</span> <span class="keyword">implements</span> <span class="title class_">Shape</span> is</span><br><span class="line">	<span class="comment">// ...</span></span><br><span class="line">  </span><br><span class="line">	<span class="comment">//注意我们正在调用的&#x27;visitDot（访问点）&#x27;方法与当前类的名称相匹配。这样我们能让访问者知晓与其交互的元素类。</span></span><br><span class="line">	method <span class="title function_">accept</span><span class="params">(v: Visitor)</span> is</span><br><span class="line">		V.visitDot(<span class="built_in">this</span>)</span><br><span class="line">		</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Circle</span> <span class="keyword">implements</span> <span class="title class_">Shape</span> is</span><br><span class="line">	<span class="comment">//...</span></span><br><span class="line">	method <span class="title function_">accept</span><span class="params">(v: Visitor)</span> is</span><br><span class="line">		V.visitcircle(<span class="built_in">this</span>)</span><br><span class="line">		</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Rectangle</span> <span class="keyword">implements</span> <span class="title class_">Shape</span> is</span><br><span class="line">	method <span class="title function_">accept</span><span class="params">(v: Visitor)</span> is</span><br><span class="line">		V.visitRectangle(<span class="built_in">this</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Compoundshape</span> <span class="keyword">implements</span> <span class="title class_">Shape</span> is</span><br><span class="line">	<span class="comment">// ...</span></span><br><span class="line">	method <span class="title function_">accept</span><span class="params">(v: Visitor)</span> is</span><br><span class="line">		V.visitcompoundshape(<span class="built_in">this</span>)</span><br><span class="line">		</span><br><span class="line"><span class="comment">// 访问者接口声明了一组与元素类对应的访问方法。访问方法的签名能让访问者准确辨别出与其交互的元素所属的类。</span></span><br><span class="line"><span class="keyword">interface</span> <span class="title class_">visitor</span> is</span><br><span class="line">	method <span class="title function_">visitDot</span><span class="params">(d: Dot)</span></span><br><span class="line">	method <span class="title function_">visitcircle</span><span class="params">(c: Circle)</span></span><br><span class="line">  method <span class="title function_">visitRectangle</span><span class="params">(r: Rectangle)</span></span><br><span class="line">	method <span class="title function_">visitCompoundshape</span><span class="params">(cs: CompoundShape)</span></span><br><span class="line">	</span><br><span class="line"><span class="comment">// 具体访问者实现了同一算法的多个版本，而且该算法能与所有具体类进行交互。访问者模式在复杂对象结构（例如组合树）上使用时能发挥最大作用。在这种情况下，它可以存储算法的一些中间状态，并同时在结构中的不同对象上执行访问者方法。这可能会非常有帮助。</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">XMLExportVisitor</span> <span class="keyword">implements</span> <span class="title class_">Visitor</span> is</span><br><span class="line">	method <span class="title function_">visitDot</span><span class="params">(d: Dot)</span> is</span><br><span class="line">		<span class="comment">// 导出点（dot）的ID和中心坐标。</span></span><br><span class="line">	method <span class="title function_">visitcircle</span><span class="params">(c: Circle)</span> is</span><br><span class="line">		<span class="comment">// 导出圆（circle）的ID、中心坐标和半径。</span></span><br><span class="line">	method <span class="title function_">visitRectangle</span><span class="params">(r: Rectangle)</span> is</span><br><span class="line">		<span class="comment">// 导出长方形（rectangle）的ID、左上角坐标、宽和长。</span></span><br><span class="line">	method <span class="title function_">visitcompoundshape</span><span class="params">(cs: CompoundShape)</span> is</span><br><span class="line">		<span class="comment">// 导出图形（shape）的ID和其子项目的ID列表。</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//客户端代码可在不知晓具体类的情况下在一组元素上运行访问者操作。“接收&quot;操作会将调用定位到访问者对象的相应操作上。</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Application</span> is</span><br><span class="line">	field allshapes: array of shapes</span><br><span class="line">	method <span class="title function_">export</span><span class="params">()</span> <span class="type">is</span></span><br><span class="line">		<span class="variable">exportVisitor</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">XMLExportVisitor</span>()</span><br><span class="line">		</span><br><span class="line">		foreach (shape in allshapes) <span class="keyword">do</span></span><br><span class="line">			shape.accept(exportVisitor)</span><br></pre></td></tr></table></figure>
<h3 id="应用场景-9"><a href="#应用场景-9" class="headerlink" title="应用场景"></a>应用场景</h3><ul>
<li><p><strong>如果你需要对一个复杂对象结构（例如对象树）中的所有元素执行某些操作，可使用访问者模式</strong></p>
<p>访问者模式通过在访问者对象中为多个目标类提供相同操作的变体，让你能在属于不同类的一组对象上执行同一操作</p>
</li>
<li><p><strong>可使用访问者模式来清理辅助行为的业务逻辑</strong></p>
<p>该模式会将所有非主要的行为抽取到一组访问者类中，使得程序的主要类能更专注于主要的工作</p>
</li>
<li><p><strong>当某个行为仅在类层次结构中的一些类中有意义，而在其他类中没有意义时，可使用该模式</strong></p>
<p>你可将该行为抽取到单独的访问者类中，只需实现接收相关类的对象作为参数的访问者方法并将其他方法留空即可</p>
</li>
</ul>
<h3 id="实现方式-9"><a href="#实现方式-9" class="headerlink" title="实现方式"></a>实现方式</h3><ol>
<li><p>在访问者接口中声明一组“访问”方法，分别对应程序中的每个具体元素类。</p>
</li>
<li><p>声明元素接口。如果程序中已有元素类层次接口，可在层次结构基类中添加抽象的“接收”方法。该方法必须接受访问者对象作为参数。  </p>
</li>
<li><p>在所有具体元素类中实现接收方法。这些方法必须将调用重定向到当前元素对应的访问者对象中的访问者方法上。  </p>
</li>
<li><p>元素类只能通过访问者接口与访问者进行交互。不过访问者必须知晓所有的具体元素类，因为这些类在访问者方法中都被作为参数类型引用。</p>
</li>
<li><p>为每个无法在元素层次结构中实现的行为创建一个具体访问者类并实现所有的访问者方法</p>
<p>你可能会遇到访问者需要访问元素类的部分私有成员变量的情况。在这种情况下，你要么将这些变量或方法设为公有，这将破坏元素的封装；要么将访问者类嵌入到元素类中。后一种方式只有在支持嵌套类的编程语言中才可能实现。  </p>
</li>
<li><p>客户端必须创建访问者对象并通过“接收”方法将其传递给元素。</p>
</li>
</ol>
<h3 id="优缺点-9"><a href="#优缺点-9" class="headerlink" title="优缺点"></a>优缺点</h3><ul>
<li>开闭原则。你可以引入在不同类对象上执行的新行为，且无需对这些类做出修改。</li>
<li>单一职责原则。可将同一行为的不同版本移到同一个类中</li>
<li>访问者对象可以在与各种对象交互时收集一些有用的信息。当你想要遍历一些复杂的对象结构（例如对象树），并在结构中的每个对象上应用访问者时，这些信息可能会有所帮助。</li>
</ul>
<hr>
<ul>
<li>每次在元素层次结构中添加或移除一个类时，你都要更新所有的访问者。</li>
<li>在访问者同某个元素进行交互时，它们可能没有访问元素私有成员变量和方法的必要权限。</li>
</ul>
<h3 id="与其他模式的关系-9"><a href="#与其他模式的关系-9" class="headerlink" title="与其他模式的关系"></a>与其他模式的关系</h3><ul>
<li>你可以将访问者视为命令模式的加强版本，其对象可对不同类的多种对象执行操作。</li>
<li>你可以使用访问者对整个组合树执行操作</li>
<li>可以同时使用访问者和迭代器来遍历复杂数据结构，并对其中的元素执行所需操作，即使这些元素所属的类完全不同</li>
</ul>

      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/%E5%BC%80%E5%8F%91%E8%BF%9B%E9%98%B6%E7%9F%A5%E8%AF%86/" rel="tag"># 开发进阶知识</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/posts/18127.html" rel="next" title="设计模式-结构型模式">
                <i class="fa fa-chevron-left"></i> 设计模式-结构型模式
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/posts/48828.html" rel="prev" title="Maven-简介">
                Maven-简介 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image"
                src="/images/avatar.jpg"
                alt="" />
            
              <p class="site-author-name" itemprop="name"></p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
                <a href="/archives">
                  <span class="site-state-item-count">87</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            


            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">14</span>
                  <span class="site-state-item-name">分类</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">11</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          

          
            <div class="links-of-author motion-element">
                
                  <span class="links-of-author-item">
                    <a href="https://github.com/xzp314" target="_blank" title="GitHub">
                      
                        <i class="fa fa-fw fa-github"></i>GitHub</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="mailto:seu_xuzhipeng@163.com" target="_blank" title="E-Mail">
                      
                        <i class="fa fa-fw fa-envelope"></i>E-Mail</a>
                  </span>
                
            </div>
          

          
          

          
          

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#%E8%A1%8C%E4%B8%BA%E6%A8%A1%E5%BC%8F"><span class="nav-number">1.</span> <span class="nav-text">行为模式</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%B4%A3%E4%BB%BB%E9%93%BE"><span class="nav-number">1.1.</span> <span class="nav-text">责任链</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%97%AE%E9%A2%98%E8%83%8C%E6%99%AF"><span class="nav-number">1.1.1.</span> <span class="nav-text">问题背景</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88"><span class="nav-number">1.1.2.</span> <span class="nav-text">解决方案</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%BB%93%E6%9E%84"><span class="nav-number">1.1.3.</span> <span class="nav-text">结构</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BC%AA%E4%BB%A3%E7%A0%81"><span class="nav-number">1.1.4.</span> <span class="nav-text">伪代码</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%BA%94%E7%94%A8%E5%9C%BA%E6%99%AF"><span class="nav-number">1.1.5.</span> <span class="nav-text">应用场景</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AE%9E%E7%8E%B0%E6%96%B9%E5%BC%8F"><span class="nav-number">1.1.6.</span> <span class="nav-text">实现方式</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BC%98%E7%BC%BA%E7%82%B9"><span class="nav-number">1.1.7.</span> <span class="nav-text">优缺点</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%B8%8E%E5%85%B6%E4%BB%96%E6%A8%A1%E5%BC%8F%E7%9A%84%E5%85%B3%E7%B3%BB"><span class="nav-number">1.1.8.</span> <span class="nav-text">与其他模式的关系</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%91%BD%E4%BB%A4"><span class="nav-number">1.2.</span> <span class="nav-text">命令</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%97%AE%E9%A2%98%E8%83%8C%E6%99%AF-1"><span class="nav-number">1.2.1.</span> <span class="nav-text">问题背景</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88-1"><span class="nav-number">1.2.2.</span> <span class="nav-text">解决方案</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%BB%93%E6%9E%84-1"><span class="nav-number">1.2.3.</span> <span class="nav-text">结构</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BC%AA%E4%BB%A3%E7%A0%81-1"><span class="nav-number">1.2.4.</span> <span class="nav-text">伪代码</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%BA%94%E7%94%A8%E5%9C%BA%E6%99%AF-1"><span class="nav-number">1.2.5.</span> <span class="nav-text">应用场景</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AE%9E%E7%8E%B0%E6%96%B9%E5%BC%8F-1"><span class="nav-number">1.2.6.</span> <span class="nav-text">实现方式</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BC%98%E7%BC%BA%E7%82%B9-1"><span class="nav-number">1.2.7.</span> <span class="nav-text">优缺点</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%B8%8E%E5%85%B6%E4%BB%96%E6%A8%A1%E5%BC%8F%E7%9A%84%E5%85%B3%E7%B3%BB-1"><span class="nav-number">1.2.8.</span> <span class="nav-text">与其他模式的关系</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%BF%AD%E4%BB%A3%E5%99%A8"><span class="nav-number">1.3.</span> <span class="nav-text">迭代器</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%97%AE%E9%A2%98%E8%83%8C%E6%99%AF-2"><span class="nav-number">1.3.1.</span> <span class="nav-text">问题背景</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88-2"><span class="nav-number">1.3.2.</span> <span class="nav-text">解决方案</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%BB%93%E6%9E%84-2"><span class="nav-number">1.3.3.</span> <span class="nav-text">结构</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BC%AA%E4%BB%A3%E7%A0%81-2"><span class="nav-number">1.3.4.</span> <span class="nav-text">伪代码</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%BA%94%E7%94%A8%E5%9C%BA%E6%99%AF-2"><span class="nav-number">1.3.5.</span> <span class="nav-text">应用场景</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AE%9E%E7%8E%B0%E6%96%B9%E5%BC%8F-2"><span class="nav-number">1.3.6.</span> <span class="nav-text">实现方式</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BC%98%E7%BC%BA%E7%82%B9-2"><span class="nav-number">1.3.7.</span> <span class="nav-text">优缺点</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%B8%8E%E5%85%B6%E4%BB%96%E6%A8%A1%E5%BC%8F%E7%9A%84%E5%85%B3%E7%B3%BB-2"><span class="nav-number">1.3.8.</span> <span class="nav-text">与其他模式的关系</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%B8%AD%E4%BB%8B%E8%80%85"><span class="nav-number">1.4.</span> <span class="nav-text">中介者</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%97%AE%E9%A2%98%E8%83%8C%E6%99%AF-3"><span class="nav-number">1.4.1.</span> <span class="nav-text">问题背景</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88-3"><span class="nav-number">1.4.2.</span> <span class="nav-text">解决方案</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%BB%93%E6%9E%84-3"><span class="nav-number">1.4.3.</span> <span class="nav-text">结构</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BC%AA%E4%BB%A3%E7%A0%81-3"><span class="nav-number">1.4.4.</span> <span class="nav-text">伪代码</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%BA%94%E7%94%A8%E5%9C%BA%E6%99%AF-3"><span class="nav-number">1.4.5.</span> <span class="nav-text">应用场景</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AE%9E%E7%8E%B0%E6%96%B9%E5%BC%8F-3"><span class="nav-number">1.4.6.</span> <span class="nav-text">实现方式</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BC%98%E7%BC%BA%E7%82%B9-3"><span class="nav-number">1.4.7.</span> <span class="nav-text">优缺点</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%B8%8E%E5%85%B6%E4%BB%96%E6%A8%A1%E5%BC%8F%E7%9A%84%E5%85%B3%E7%B3%BB-3"><span class="nav-number">1.4.8.</span> <span class="nav-text">与其他模式的关系</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%A4%87%E5%BF%98%E5%BD%95"><span class="nav-number">1.5.</span> <span class="nav-text">备忘录</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%97%AE%E9%A2%98%E8%83%8C%E6%99%AF-4"><span class="nav-number">1.5.1.</span> <span class="nav-text">问题背景</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88-4"><span class="nav-number">1.5.2.</span> <span class="nav-text">解决方案</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%BB%93%E6%9E%84-4"><span class="nav-number">1.5.3.</span> <span class="nav-text">结构</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%9F%BA%E4%BA%8E%E5%B5%8C%E5%A5%97%E7%B1%BB%E7%9A%84%E5%AE%9E%E7%8E%B0"><span class="nav-number">1.5.3.1.</span> <span class="nav-text">基于嵌套类的实现</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BC%AA%E4%BB%A3%E7%A0%81-4"><span class="nav-number">1.5.4.</span> <span class="nav-text">伪代码</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%BA%94%E7%94%A8%E5%9C%BA%E6%99%AF-4"><span class="nav-number">1.5.5.</span> <span class="nav-text">应用场景</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AE%9E%E7%8E%B0%E6%96%B9%E5%BC%8F-4"><span class="nav-number">1.5.6.</span> <span class="nav-text">实现方式</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BC%98%E7%BC%BA%E7%82%B9-4"><span class="nav-number">1.5.7.</span> <span class="nav-text">优缺点</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%B8%8E%E5%85%B6%E4%BB%96%E6%A8%A1%E5%BC%8F%E7%9A%84%E5%85%B3%E7%B3%BB-4"><span class="nav-number">1.5.8.</span> <span class="nav-text">与其他模式的关系</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%A7%82%E5%AF%9F%E8%80%85"><span class="nav-number">1.6.</span> <span class="nav-text">观察者</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%97%AE%E9%A2%98%E8%83%8C%E6%99%AF-5"><span class="nav-number">1.6.1.</span> <span class="nav-text">问题背景</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88-5"><span class="nav-number">1.6.2.</span> <span class="nav-text">解决方案</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%BB%93%E6%9E%84-5"><span class="nav-number">1.6.3.</span> <span class="nav-text">结构</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BC%AA%E4%BB%A3%E7%A0%81-5"><span class="nav-number">1.6.4.</span> <span class="nav-text">伪代码</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%BA%94%E7%94%A8%E5%9C%BA%E6%99%AF-5"><span class="nav-number">1.6.5.</span> <span class="nav-text">应用场景</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AE%9E%E7%8E%B0%E6%96%B9%E5%BC%8F-5"><span class="nav-number">1.6.6.</span> <span class="nav-text">实现方式</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BC%98%E7%BC%BA%E7%82%B9-5"><span class="nav-number">1.6.7.</span> <span class="nav-text">优缺点</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%B8%8E%E5%85%B6%E4%BB%96%E6%A8%A1%E5%BC%8F%E7%9A%84%E5%85%B3%E7%B3%BB-5"><span class="nav-number">1.6.8.</span> <span class="nav-text">与其他模式的关系</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%8A%B6%E6%80%81"><span class="nav-number">1.7.</span> <span class="nav-text">状态</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%97%AE%E9%A2%98%E8%83%8C%E6%99%AF-6"><span class="nav-number">1.7.1.</span> <span class="nav-text">问题背景</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88-6"><span class="nav-number">1.7.2.</span> <span class="nav-text">解决方案</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%BB%93%E6%9E%84-6"><span class="nav-number">1.7.3.</span> <span class="nav-text">结构</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BC%AA%E4%BB%A3%E7%A0%81-6"><span class="nav-number">1.7.4.</span> <span class="nav-text">伪代码</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%BA%94%E7%94%A8%E5%9C%BA%E6%99%AF-6"><span class="nav-number">1.7.5.</span> <span class="nav-text">应用场景</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%AE%9E%E7%8E%B0%E6%96%B9%E5%BC%8F-6"><span class="nav-number">1.7.5.1.</span> <span class="nav-text">实现方式</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%BC%98%E7%BC%BA%E7%82%B9-6"><span class="nav-number">1.7.5.2.</span> <span class="nav-text">优缺点</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%B8%8E%E5%85%B6%E4%BB%96%E6%A8%A1%E5%BC%8F%E7%9A%84%E5%85%B3%E7%B3%BB-6"><span class="nav-number">1.7.6.</span> <span class="nav-text">与其他模式的关系</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%AD%96%E7%95%A5"><span class="nav-number">1.7.7.</span> <span class="nav-text">策略</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%97%AE%E9%A2%98%E8%83%8C%E6%99%AF-7"><span class="nav-number">1.7.8.</span> <span class="nav-text">问题背景</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88-7"><span class="nav-number">1.7.9.</span> <span class="nav-text">解决方案</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%BB%93%E6%9E%84-7"><span class="nav-number">1.7.10.</span> <span class="nav-text">结构</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BC%AA%E4%BB%A3%E7%A0%81-7"><span class="nav-number">1.7.11.</span> <span class="nav-text">伪代码</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%BA%94%E7%94%A8%E5%9C%BA%E6%99%AF-7"><span class="nav-number">1.7.12.</span> <span class="nav-text">应用场景</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AE%9E%E7%8E%B0%E6%96%B9%E5%BC%8F-7"><span class="nav-number">1.7.13.</span> <span class="nav-text">实现方式</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BC%98%E7%BC%BA%E7%82%B9-7"><span class="nav-number">1.7.14.</span> <span class="nav-text">优缺点</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%B8%8E%E5%85%B6%E4%BB%96%E6%A8%A1%E5%BC%8F%E7%9A%84%E5%85%B3%E7%B3%BB-7"><span class="nav-number">1.7.15.</span> <span class="nav-text">与其他模式的关系</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%A8%A1%E6%9D%BF%E6%96%B9%E6%B3%95"><span class="nav-number">1.8.</span> <span class="nav-text">模板方法</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%97%AE%E9%A2%98%E8%83%8C%E6%99%AF-8"><span class="nav-number">1.8.1.</span> <span class="nav-text">问题背景</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88-8"><span class="nav-number">1.8.2.</span> <span class="nav-text">解决方案</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%BB%93%E6%9E%84-8"><span class="nav-number">1.8.3.</span> <span class="nav-text">结构</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BC%AA%E4%BB%A3%E7%A0%81-8"><span class="nav-number">1.8.4.</span> <span class="nav-text">伪代码</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%BA%94%E7%94%A8%E5%9C%BA%E6%99%AF-8"><span class="nav-number">1.8.5.</span> <span class="nav-text">应用场景</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AE%9E%E7%8E%B0%E6%96%B9%E5%BC%8F-8"><span class="nav-number">1.8.6.</span> <span class="nav-text">实现方式</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BC%98%E7%BC%BA%E7%82%B9-8"><span class="nav-number">1.8.7.</span> <span class="nav-text">优缺点</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%B8%8E%E5%85%B6%E4%BB%96%E6%A8%A1%E5%BC%8F%E7%9A%84%E5%85%B3%E7%B3%BB-8"><span class="nav-number">1.8.8.</span> <span class="nav-text">与其他模式的关系</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%AE%BF%E9%97%AE%E8%80%85"><span class="nav-number">1.9.</span> <span class="nav-text">访问者</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%97%AE%E9%A2%98%E8%83%8C%E6%99%AF-9"><span class="nav-number">1.9.1.</span> <span class="nav-text">问题背景</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88-9"><span class="nav-number">1.9.2.</span> <span class="nav-text">解决方案</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%BB%93%E6%9E%84-9"><span class="nav-number">1.9.3.</span> <span class="nav-text">结构</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BC%AA%E4%BB%A3%E7%A0%81-9"><span class="nav-number">1.9.4.</span> <span class="nav-text">伪代码</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%BA%94%E7%94%A8%E5%9C%BA%E6%99%AF-9"><span class="nav-number">1.9.5.</span> <span class="nav-text">应用场景</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AE%9E%E7%8E%B0%E6%96%B9%E5%BC%8F-9"><span class="nav-number">1.9.6.</span> <span class="nav-text">实现方式</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BC%98%E7%BC%BA%E7%82%B9-9"><span class="nav-number">1.9.7.</span> <span class="nav-text">优缺点</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%B8%8E%E5%85%B6%E4%BB%96%E6%A8%A1%E5%BC%8F%E7%9A%84%E5%85%B3%E7%B3%BB-9"><span class="nav-number">1.9.8.</span> <span class="nav-text">与其他模式的关系</span></a></li></ol></li></ol></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2024</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Xu Zhipeng</span>

  
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-area-chart"></i>
    </span>
    
      <span class="post-meta-item-text">Site words total count&#58;</span>
    
    <span title="Site words total count">244.3k</span>
  
</div>


  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Pisces</a> v5.1.4</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  


  











  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  

  
  
    <script type="text/javascript" src="/lib/canvas-nest/canvas-nest.min.js"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.4"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  

  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  

  

  
  

  
  


  

  

</body>
</html>
